<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“åˆ©æ¶¦åˆ†æä¸“ä¸šç‰ˆ</title>
    <!-- SheetJS åº“ç”¨äºè§£æ Excel æ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            /* ä¸»è‰²ç³» */
            --primary-color: #2563eb;
            --primary-hover: #1d4ed8;
            --primary-light: #dbeafe;
            
            /* è¯­ä¹‰è‰²å½© */
            --success-color: #059669;
            --success-light: #d1fae5;
            --danger-color: #dc2626;
            --danger-light: #fee2e2;
            --warning-color: #d97706;
            --warning-light: #fef3c7;
            
            /* ä¸­æ€§è‰² */
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            
            /* å¸ƒå±€ */
            --header-height: 64px;
            --sidebar-width: 280px;
            --border-radius: 8px;
            --border-radius-lg: 12px;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            /* å­—ä½“ */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.6;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            height: var(--header-height);
            background: white;
            border-bottom: 1px solid var(--gray-200);
            box-shadow: var(--shadow);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
        }

        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 20px;
            color: var(--primary-color);
        }

        .navbar-brand-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .navbar-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-icon {
            padding: 8px;
            width: 40px;
            height: 40px;
            justify-content: center;
        }

        /* ä¸»å¸ƒå±€ */
        .main-layout {
            margin-top: var(--header-height);
            display: flex;
            min-height: calc(100vh - var(--header-height));
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: var(--sidebar-width);
            background: white;
            border-right: 1px solid var(--gray-200);
            overflow-y: auto;
        }

        .sidebar-section {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .input-group {
            display: flex;
            gap: 8px;
        }

        .input-group .form-input {
            flex: 1;
        }

        .input-addon {
            display: flex;
            align-items: center;
            padding: 0 12px;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: var(--border-radius);
            font-size: 14px;
            color: var(--gray-600);
        }

        /* äº§å“åˆ—è¡¨ */
        .product-list {
            padding: 16px 24px;
        }

        .product-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .product-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .product-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        .product-card.active {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .product-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .product-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .product-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-profit {
            background: var(--success-light);
            color: var(--success-color);
        }

        .status-loss {
            background: var(--danger-light);
            color: var(--danger-color);
        }

        .product-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 12px;
            color: var(--gray-600);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 24px;
        }

        .content-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .content-subtitle {
            color: var(--gray-600);
            margin-bottom: 16px;
        }

        .content-actions {
            display: flex;
            gap: 12px;
        }

        /* æ•°æ®è¡¨æ ¼ */
        .table-container {
            flex: 1;
            overflow: hidden;
            padding: 24px;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .data-table {
            width: 100%;
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: fit-content;
        }

        /* è¡¨æ ¼æ»šåŠ¨å®¹å™¨ */
        .table-scroll-container {
            overflow-x: auto;
            overflow-y: visible;
            position: relative;
            max-height: fit-content;
        }

        /* å›ºå®šé¦–åˆ—çš„è¡¨æ ¼å¸ƒå±€ */
        .table-wrapper {
            display: flex;
            min-width: 2100px;
        }

        /* å›ºå®šåˆ—ï¼ˆäº§å“åç§°ï¼‰ */
        .fixed-column {
            width: 170px;
            min-width: 170px;
            background: white;
            border-right: 2px solid var(--primary-color);
            z-index: 20;
            position: sticky;
            left: 0;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }

        /* å¯æ»šåŠ¨åˆ— */
        .scrollable-columns {
            flex: 1;
            min-width: 1950px;
        }

        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .table-scroll-container::-webkit-scrollbar {
            width: 16px;
            height: 16px;
        }

        .table-scroll-container::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 8px;
        }

        .table-scroll-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 8px;
            border: 2px solid var(--gray-100);
        }

        .table-scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--primary-hover);
        }

        .table-scroll-container::-webkit-scrollbar-corner {
            background: var(--gray-100);
        }
        
        /* å¼ºåˆ¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        .table-scroll-container {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--gray-100);
        }

        /* æ»šåŠ¨æ¡æç¤º */
        .scroll-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 30;
            opacity: 0.9;
            transition: opacity 0.3s ease;
            pointer-events: none;
            box-shadow: var(--shadow-lg);
        }

        .scroll-hint.hidden {
            opacity: 0;
        }

        .table-header {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            height: 60px;
            min-height: 60px;
        }

        .table-row {
            display: grid;
            grid-template-columns: 
                100px /* æ¨å¹¿é¢„ç®— */
                120px /* æ¨å¹¿å®é™…åˆ©æ¶¦ */
                120px /* æ¯å•å®é™…åˆ©æ¶¦ */
                120px /* æˆäº¤æ¯å•æˆæœ¬ */
                120px /* æ¨å¹¿é”€å”®å•æ•° */
                120px /* æ¨å¹¿é”€å”®é¢ */
                100px /* å•†åŸæ‰£ç‚¹ */
                100px /* è¿è´¹å æ¯” */
                100px /* æ¯å•è¿è´¹ */
                100px /* äººå‘˜å¼€é”€ */
                100px /* äº§å“å”®ä»· */
                100px /* äº§å“æˆæœ¬ */
                100px /* ç‚¹å‡»å•ä»· */
                100px /* è½¬åŒ–ç‡ */
                100px /* æŠ•äº§æ¯” */
                100px /* å®¢å•ä»· */
                120px /* å®é™…åˆ©æ¶¦ç‡ */
                120px /* å”®ä»·åˆ©æ¶¦ç‡ */
                120px /* ä¿æœ¬åˆ©æ¶¦ç‡ */
                100px /* æ¶¨ä»·ä¿æœ¬ */
                100px /* é™æœ¬ä¿æœ¬ */
                80px; /* æ“ä½œ */
            gap: 1px;
            background: var(--gray-200);
            height: 60px;
            min-height: 60px;
        }
        
        .fixed-column .table-row {
            display: block;
            height: 60px;
            min-height: 60px;
        }
        
        .fixed-column .table-cell {
            width: 100%;
            border-right: none;
        }

        .table-cell {
            background: white;
            padding: 12px 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60px;
            box-sizing: border-box;
        }
        
        /* å›ºå®šåˆ—å•å…ƒæ ¼æ ·å¼ */
        .fixed-column .table-cell {
            height: 60px;
            min-height: 60px;
            max-height: 60px;
            padding: 8px;
            border-bottom: 1px solid var(--gray-200);
        }
        
        /* æ»šåŠ¨åˆ—å•å…ƒæ ¼æ ·å¼ */
        .scrollable-columns .table-cell {
            height: 60px;
            min-height: 60px;
            max-height: 60px;
            border-bottom: 1px solid var(--gray-200);
        }

        .table-header .table-cell {
            background: var(--gray-50);
            font-weight: 600;
            color: var(--gray-700);
            font-size: 12px;
            text-align: center;
            height: 60px;
            min-height: 60px;
            max-height: 60px;
        }
        
        .table-cell.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .table-cell.sortable:hover {
            background: var(--gray-200);
        }
        
        .sort-icon {
            margin-left: 4px;
            font-size: 10px;
            color: var(--gray-400);
        }
        
        .sort-icon.active {
            color: var(--primary-color);
        }

        .cell-label {
            font-size: 10px;
            color: var(--gray-500);
            margin-bottom: 4px;
            text-align: center;
        }

        .cell-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            box-sizing: border-box;
            height: 26px;
        }

        .cell-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .cell-value {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 6px;
            border-radius: 4px;
            text-align: center;
            min-width: 60px;
        }

        .cell-value.positive {
            background: var(--success-light);
            color: var(--success-color);
        }

        .cell-value.negative {
            background: var(--danger-light);
            color: var(--danger-color);
        }

        .cell-value.neutral {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        /* é€‰ä¸­è¡Œé«˜äº®æ ·å¼ */
        .table-row-selected {
            background: var(--primary-light) !important;
        }
        
        .table-row-selected .table-cell {
            background: var(--primary-light) !important;
            border-left: 3px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .table-row-selected .cell-input {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--primary-color);
        }
        
        .table-row-selected .cell-value {
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(37, 99, 235, 0.1);
        }
        
        /* å›ºå®šåˆ—é€‰ä¸­æ ·å¼ */
        .fixed-row-selected {
            background: var(--primary-light) !important;
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .fixed-row-selected .cell-input {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--primary-color);
            font-weight: 600;
        }

        /* å•é€‰äº§å“é«˜äº®æ ·å¼ï¼ˆä¸å¤šé€‰ä¸åŒçš„é¢œè‰²ï¼‰ */
        .table-row-active {
            background: var(--warning-light) !important;
        }
        
        .table-row-active .table-cell {
            background: var(--warning-light) !important;
            border-left: 3px solid var(--warning-color);
            transition: all 0.3s ease;
        }
        
        .table-row-active .cell-input {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--warning-color);
        }
        
        .table-row-active .cell-value {
            font-weight: 600;
            box-shadow: 0 1px 3px rgba(215, 119, 6, 0.1);
        }
        
        /* å›ºå®šåˆ—å•é€‰æ ·å¼ */
        .fixed-row-active {
            background: var(--warning-light) !important;
            border-left: 4px solid var(--warning-color);
            transition: all 0.3s ease;
        }
        
        .fixed-row-active .cell-input {
            background: rgba(255, 255, 255, 0.9);
            border-color: var(--warning-color);
            font-weight: 600;
        }

        /* å·¥å…·æç¤ºæ ·å¼ */
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip::before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-800);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-line;
            min-width: 200px;
            max-width: 350px;
            text-align: left;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .tooltip::after {
            content: '';
            position: absolute;
            bottom: 117%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--gray-800);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .tooltip:hover::before,
        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        /* ç¡®ä¿tooltipåœ¨è¡¨æ ¼ä¸­æ­£ç¡®æ˜¾ç¤º */
        .table-cell .tooltip::before {
            bottom: 130%;
            z-index: 1000;
        }
        
        .table-cell .tooltip::after {
            bottom: 122%;
            z-index: 1001;
        }

        /* ç»Ÿè®¡é¢æ¿ */
        .stats-panel {
            background: white;
            border-top: 1px solid var(--gray-200);
            padding: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 24px;
        }

        .stat-card {
            background: var(--gray-50);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 500;
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: var(--header-height);
                height: calc(100vh - var(--header-height));
                z-index: 999;
                transition: left 0.3s ease;
            }

            .sidebar.open {
                left: 0;
            }

            .main-content {
                margin-left: 0;
            }

            .table-row {
                grid-template-columns: 1fr;
                gap: 0;
            }

            .table-cell {
                border-bottom: 1px solid var(--gray-200);
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            height: 300px;
            margin-top: 20px;
            background: white;
            border-radius: var(--border-radius-lg);
            padding: 20px;
            box-shadow: var(--shadow);
        }

        /* æµ®åŠ¨æ“ä½œæŒ‰é’® */
        .fab {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            font-size: 24px;
            transition: all 0.2s ease;
        }

        .fab:hover {
            background: var(--primary-hover);
            transform: scale(1.1);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 800px;
            max-height: 80vh;
            width: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--gray-900);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--gray-500);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid var(--gray-200);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .import-step {
            margin-bottom: 24px;
        }

        .import-step h4 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }

        .import-step p {
            color: var(--gray-600);
            margin-bottom: 16px;
        }

        .file-drop-zone {
            border: 2px dashed var(--gray-300);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            color: var(--gray-500);
            margin-top: 16px;
            transition: border-color 0.2s ease;
        }

        .file-drop-zone:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .file-drop-zone.drag-over {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }

        .field-mapping {
            display: grid;
            gap: 16px;
        }

        .field-map-item {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
            padding: 16px;
            background: var(--gray-50);
            border-radius: var(--border-radius);
        }

        .field-source {
            text-align: right;
            font-weight: 500;
            color: var(--gray-700);
        }

        .field-arrow {
            color: var(--primary-color);
            font-size: 18px;
        }

        .field-target {
            font-weight: 500;
            color: var(--primary-color);
        }

        .data-preview {
            max-height: 300px;
            overflow: auto;
            border: 1px solid var(--gray-200);
            border-radius: var(--border-radius);
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
            font-size: 12px;
        }

        .preview-table th {
            background: var(--gray-50);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .preview-table tr:hover {
            background: var(--gray-50);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-brand">
            <div class="navbar-brand-icon">P</div>
            <span>äº§å“åˆ©æ¶¦åˆ†æä¸“ä¸šç‰ˆ</span>
        </div>
        <div class="navbar-actions">
            <button class="btn btn-secondary btn-icon" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
            <button class="btn btn-secondary" onclick="exportData()">
                ğŸ“Š å¯¼å‡ºæŠ¥å‘Š
            </button>
            <button class="btn btn-primary" onclick="addProduct()">
                â• æ·»åŠ äº§å“
            </button>
        </div>
    </nav>

    <!-- ä¸»å¸ƒå±€ -->
    <div class="main-layout">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <!-- å…¨å±€è®¾ç½® -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">ğŸŒ å…¨å±€è®¾ç½®</h3>
                
                <div class="form-group">
                    <label class="form-label">æ¨å¹¿é¢„ç®—æ€»é¢</label>
                    <div class="input-group">
                        <input type="number" class="form-input" id="globalPromotionBudget" 
                               placeholder="0.00" step="0.01" onchange="updateGlobalBudget()">
                        <span class="input-addon">Â¥</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">é¢„ç®—åˆ†é…æ–¹å¼</label>
                    <select class="form-input" id="budgetAllocation" onchange="updateBudgetAllocation()">
                        <option value="each_full">æ¯åº—æ¨å¹¿é¢„ç®—æ€»é¢</option>
                        <option value="equal">å¹³å‡åˆ†é…</option>
                        <option value="weighted">æŒ‰æƒé‡åˆ†é…</option>
                        <option value="manual">æ‰‹åŠ¨åˆ†é…</option>
                    </select>
                </div>
            </div>

            <!-- é»˜è®¤å‚æ•° -->
            <div class="sidebar-section">
                <h3 class="sidebar-title">âš™ï¸ é»˜è®¤å‚æ•°</h3>
                
                <div class="form-group">
                    <label class="form-label">å•†åŸæ‰£ç‚¹</label>
                    <div class="input-group">
                        <input type="number" class="form-input" id="defaultPlatformFee" 
                               value="8.0" step="0.1" onchange="updateDefaultParams()">
                        <span class="input-addon">%</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">è¿è´¹å æ¯”</label>
                    <div class="input-group">
                        <input type="number" class="form-input" id="defaultShippingRate" 
                               value="7.0" step="0.1" onchange="updateDefaultParams()">
                        <span class="input-addon">%</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">äººå‘˜å¼€é”€</label>
                    <div class="input-group">
                        <input type="number" class="form-input" id="defaultLaborCost" 
                               value="5.0" step="0.1" onchange="updateDefaultParams()">
                        <span class="input-addon">%</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">å›½è¡¥ä¼˜æƒ ç³»æ•°</label>
                    <div class="input-group">
                        <input type="number" class="form-input" id="defaultSubsidyRate" 
                               value="0.85" step="0.01" min="0" max="1" onchange="updateDefaultParams()">
                        <span class="input-addon">å€</span>
                    </div>
                    <small style="color: var(--gray-500); font-size: 12px; margin-top: 4px; display: block;">
                        å®¢å•ä»· = ROI Ã— ç‚¹å‡»å•ä»· Ã· è½¬åŒ–ç‡ Ã— æ­¤ç³»æ•°
                    </small>
                </div>
            </div>

            <!-- äº§å“åˆ—è¡¨ -->
            <div class="sidebar-section">
                <div class="product-list-header">
                    <h3 class="sidebar-title">ğŸ“¦ äº§å“åˆ—è¡¨</h3>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="badge" id="productCount">0</span>
                        <button class="btn btn-secondary btn-icon" onclick="quickSelectAll()" title="å¿«é€Ÿå…¨é€‰/å–æ¶ˆå…¨é€‰" style="padding: 4px; font-size: 12px; width: 24px; height: 24px;">â˜‘ï¸</button>
                    </div>
                </div>
                <div class="product-list" id="productList">
                    <!-- äº§å“å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="main-content">
            <!-- å†…å®¹å¤´éƒ¨ -->
            <div class="content-header">
                <h1 class="content-title">æ•°æ®åˆ†æé¢æ¿</h1>
                <p class="content-subtitle">å®æ—¶ç›‘æ§äº§å“åˆ©æ¶¦è¡¨ç°ï¼Œä¼˜åŒ–æŠ•èµ„å›æŠ¥ç‡</p>
                <div class="content-actions">
                    <button class="btn btn-secondary" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                    <button class="btn btn-secondary" onclick="importTableData()">ğŸ“Š å¯¼å…¥è¡¨æ ¼</button>
                    <button class="btn btn-secondary" onclick="importData()">ğŸ“‚ å¯¼å…¥æ•°æ®</button>
                    <button class="btn btn-secondary" onclick="openColumnConfig()">âš™ï¸ æŒ‡æ ‡é…ç½®</button>
                    <button class="btn btn-secondary" id="applyDefaultBtn" onclick="applyDefaultConfig()" style="display: none; background: var(--primary-color); color: white;">
                        âš™ï¸ åº”ç”¨é»˜è®¤é…ç½® (<span id="applySelectedCount">0</span>)
                    </button>
                    <button class="btn btn-secondary" id="batchSetBtn" onclick="openBatchSettings()" style="display: none; background: var(--success-color); color: white;">
                        ğŸ“ æ‰¹é‡è®¾ç½® (<span id="batchSetCount">0</span>)
                    </button>
                    <button class="btn btn-secondary" id="batchDeleteBtn" onclick="batchDeleteProducts()" style="display: none; background: var(--danger-color); color: white;">
                        ğŸ—‘ï¸ æ‰¹é‡åˆ é™¤ (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-primary" onclick="generateReport()">ğŸ“ˆ ç”ŸæˆæŠ¥å‘Š</button>
                </div>
            </div>

            <!-- æ•°æ®è¡¨æ ¼ -->
            <div class="table-container" id="tableContainer">
                <div class="data-table">
                    <div class="table-scroll-container">
                        <div class="table-wrapper">
                            <!-- å›ºå®šé¦–åˆ— -->
                            <div class="fixed-column">
                                <div class="table-header">
                                    <div class="table-cell">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" style="margin-right: 6px;">
                                        äº§å“åç§°
                                    </div>
                                </div>
                                <div id="fixedColumnBody">
                                    <!-- å›ºå®šåˆ—æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                            
                            <!-- å¯æ»šåŠ¨åˆ— -->
                            <div class="scrollable-columns">
                                <div class="table-header">
                                    <div class="table-row" id="dynamicTableHeader">
                                        <!-- è¡¨å¤´å°†æ ¹æ®æŒ‡æ ‡é…ç½®åŠ¨æ€ç”Ÿæˆ -->
                                    </div>
                                </div>
                                <div id="scrollableTableBody">
                                    <!-- å¯æ»šåŠ¨åˆ—æ•°æ®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- æ»šåŠ¨æç¤º -->
                <div class="scroll-hint" id="scrollHint">
                    â† â†’ å·¦å³æ»‘åŠ¨æŸ¥çœ‹æ›´å¤šæ•°æ®
                </div>
            </div>

            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="stats-panel">
                <div class="stats-grid" id="statsGrid">
                    <!-- ç»Ÿè®¡å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="chart-container" id="chartContainer">
                    <!-- å›¾è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </main>
    </div>

    <!-- æµ®åŠ¨æ“ä½œæŒ‰é’® -->
    <button class="fab" onclick="quickAdd()" title="å¿«é€Ÿæ·»åŠ äº§å“">â•</button>

    <!-- è¡¨æ ¼å¯¼å…¥æ¨¡æ€æ¡† -->
    <div id="importModal" class="modal" style="display: none;" onclick="closeImportModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ğŸ“Š å¯¼å…¥è¡¨æ ¼æ•°æ®</h3>
                <button class="modal-close" onclick="closeImportModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="import-step" id="step1">
                    <h4>æ­¥éª¤ 1: é€‰æ‹©æ–‡ä»¶</h4>
                    <p>æ”¯æŒå¤šç§è¡¨æ ¼æ ¼å¼ï¼šExcel (.xlsx, .xls)ã€CSV (.csv)ã€TSV (.tsv)ã€OpenDocument (.ods)</p>
                    <input type="file" id="tableFileInput" accept=".xlsx,.xls,.csv,.tsv,.ods" onchange="handleTableFile(event)">
                    <div class="file-drop-zone" id="fileDropZone">
                        <p>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶</p>
                        <small style="color: var(--gray-500); margin-top: 8px; display: block;">
                            æ”¯æŒçš„æ ¼å¼ï¼šExcelã€CSVã€TSVã€ODS
                        </small>
                    </div>
                </div>
                
                <div class="import-step" id="step2" style="display: none;">
                    <h4>æ­¥éª¤ 2: å­—æ®µæ˜ å°„</h4>
                    <p>ç³»ç»Ÿå·²è‡ªåŠ¨è¯†åˆ«å­—æ®µï¼Œè¯·ç¡®è®¤æ˜ å°„å…³ç³»ï¼š</p>
                    <div class="field-mapping" id="fieldMapping">
                        <!-- å­—æ®µæ˜ å°„å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="import-step" id="step3" style="display: none;">
                    <h4>æ­¥éª¤ 3: æ•°æ®é¢„è§ˆ</h4>
                    <div class="data-preview" id="dataPreview">
                        <!-- æ•°æ®é¢„è§ˆå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeImportModal()">å–æ¶ˆ</button>
                <button class="btn btn-secondary" id="prevBtn" onclick="prevStep()" style="display: none;">ä¸Šä¸€æ­¥</button>
                <button class="btn btn-primary" id="nextBtn" onclick="nextStep()" style="display: none;">ä¸‹ä¸€æ­¥</button>
                <button class="btn btn-primary" id="importBtn" onclick="confirmImport()" style="display: none;">å¯¼å…¥æ•°æ®</button>
            </div>
        </div>
    </div>

    <!-- æŒ‡æ ‡é…ç½®æ¨¡æ€æ¡† -->
    <div id="columnConfigModal" class="modal" style="display: none;" onclick="closeColumnConfig()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>âš™ï¸ æŒ‡æ ‡é…ç½®</h3>
                <button class="modal-close" onclick="closeColumnConfig()">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 24px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 8px;">é€‰æ‹©è¦æ˜¾ç¤ºçš„æŒ‡æ ‡</h4>
                    <p style="color: var(--gray-600); margin-bottom: 16px; font-size: 14px;">
                        å‹¾é€‰æ‚¨å¸Œæœ›åœ¨æ•°æ®è¡¨æ ¼ä¸­æ˜¾ç¤ºçš„æŒ‡æ ‡åˆ—ï¼Œæœªå‹¾é€‰çš„æŒ‡æ ‡å°†è¢«éšè—ã€‚é…ç½®ä¼šè‡ªåŠ¨ä¿å­˜ã€‚
                    </p>
                </div>
                
                <div class="field-mapping" id="columnConfigList">
                    <!-- æŒ‡æ ‡é…ç½®é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <div style="margin-top: 24px; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                    <h5 style="margin: 0 0 8px 0; color: var(--gray-700);">å¿«é€Ÿæ“ä½œ</h5>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="selectAllColumns()" style="font-size: 12px; padding: 6px 12px;">å…¨é€‰</button>
                        <button class="btn btn-secondary" onclick="selectNoneColumns()" style="font-size: 12px; padding: 6px 12px;">å…¨ä¸é€‰</button>
                        <button class="btn btn-secondary" onclick="selectCoreColumns()" style="font-size: 12px; padding: 6px 12px;">æ ¸å¿ƒæŒ‡æ ‡</button>
                        <button class="btn btn-secondary" onclick="selectProfitColumns()" style="font-size: 12px; padding: 6px 12px;">åˆ©æ¶¦åˆ†æ</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeColumnConfig()">å…³é—­</button>
                <button class="btn btn-primary" onclick="applyColumnConfig()">åº”ç”¨é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="batchSettingsModal" class="modal" style="display: none;" onclick="closeBatchSettings()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3>ğŸ“ æ‰¹é‡è®¾ç½®å‚æ•°</h3>
                <button class="modal-close" onclick="closeBatchSettings()">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 24px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 8px;">
                        æ‰¹é‡è®¾ç½® <span id="batchSettingsCount">0</span> ä¸ªäº§å“çš„å‚æ•°
                    </h4>
                    <p style="color: var(--gray-600); margin-bottom: 16px; font-size: 14px;">
                        å¡«å†™è¦æ‰¹é‡è®¾ç½®çš„å‚æ•°å€¼ï¼Œç©ºç™½å­—æ®µå°†ä¿æŒäº§å“å½“å‰å€¼ä¸å˜ã€‚
                    </p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="form-group">
                        <label class="form-label">å•†åŸæ‰£ç‚¹ (%)</label>
                        <div class="input-group">
                            <input type="number" class="form-input" id="batchPlatformFee" 
                                   placeholder="å¦‚ï¼š8.0" step="0.1" min="0" max="100">
                            <span class="input-addon">%</span>
                        </div>
                        <small style="color: var(--gray-500); font-size: 12px; margin-top: 4px; display: block;">
                            å¹³å°æ”¶å–çš„äº¤æ˜“æ‰‹ç»­è´¹
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">è¿è´¹å æ¯” (%)</label>
                        <div class="input-group">
                            <input type="number" class="form-input" id="batchShippingRate" 
                                   placeholder="å¦‚ï¼š7.0" step="0.1" min="0" max="100">
                            <span class="input-addon">%</span>
                        </div>
                        <small style="color: var(--gray-500); font-size: 12px; margin-top: 4px; display: block;">
                            è¿è´¹å å”®ä»·çš„ç™¾åˆ†æ¯”
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">äººå‘˜å¼€é”€ (%)</label>
                        <div class="input-group">
                            <input type="number" class="form-input" id="batchLaborCost" 
                                   placeholder="å¦‚ï¼š5.0" step="0.1" min="0" max="100">
                            <span class="input-addon">%</span>
                        </div>
                        <small style="color: var(--gray-500); font-size: 12px; margin-top: 4px; display: block;">
                            äººåŠ›æˆæœ¬å å”®ä»·çš„ç™¾åˆ†æ¯”
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å›½è¡¥ä¼˜æƒ ç³»æ•°</label>
                        <div class="input-group">
                            <input type="number" class="form-input" id="batchSubsidyRate" 
                                   placeholder="å¦‚ï¼š0.85" step="0.01" min="0" max="1">
                            <span class="input-addon">å€</span>
                        </div>
                        <small style="color: var(--gray-500); font-size: 12px; margin-top: 4px; display: block;">
                            å½±å“å®é™…å”®ä»·è®¡ç®—çš„ç³»æ•°
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">æ¯å•è¿è´¹ (Â¥)</label>
                        <div class="input-group">
                            <input type="number" class="form-input" id="batchShippingCostPerOrder" 
                                   placeholder="å¦‚ï¼š15.00" step="0.01" min="0">
                            <span class="input-addon">Â¥</span>
                        </div>
                        <small style="color: var(--gray-500); font-size: 12px; margin-top: 4px; display: block;">
                            æ¯ç¬”è®¢å•çš„è¿è´¹é‡‘é¢
                        </small>
                    </div>

                    <div class="form-group">
                        <label class="form-label">äº§å“æƒé‡</label>
                        <div class="input-group">
                            <input type="number" class="form-input" id="batchWeight" 
                                   placeholder="å¦‚ï¼š1" step="1" min="1">
                            <span class="input-addon">å€</span>
                        </div>
                        <small style="color: var(--gray-500); font-size: 12px; margin-top: 4px; display: block;">
                            ç”¨äºé¢„ç®—æƒé‡åˆ†é…
                        </small>
                    </div>
                </div>
                
                <div style="margin-top: 24px; padding: 16px; background: var(--primary-light); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                    <h5 style="margin: 0 0 8px 0; color: var(--primary-color);">ğŸ’¡ ä½¿ç”¨æç¤º</h5>
                    <ul style="margin: 0; padding-left: 16px; color: var(--gray-700); font-size: 13px;">
                        <li>åªæœ‰å¡«å†™äº†æ•°å€¼çš„å­—æ®µæ‰ä¼šè¢«æ‰¹é‡è®¾ç½®</li>
                        <li>ç©ºç™½å­—æ®µå°†ä¿æŒæ¯ä¸ªäº§å“çš„å½“å‰å€¼ä¸å˜</li>
                        <li>è¿è´¹å æ¯”å’Œæ¯å•è¿è´¹ä¼šè‡ªåŠ¨è”åŠ¨è®¡ç®—</li>
                        <li>è®¾ç½®åä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—æ‰€æœ‰ç›¸å…³æŒ‡æ ‡</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="clearBatchForm()">æ¸…ç©ºè¡¨å•</button>
                <button class="btn btn-secondary" onclick="closeBatchSettings()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="applyBatchSettings()">åº”ç”¨è®¾ç½®</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€ç®¡ç†
        let globalState = {
            promotionBudget: 10000,
            budgetAllocation: 'each_full',
            defaultParams: {
                platformFee: 8.0,
                shippingRate: 7.0,
                laborCost: 5.0,
                shippingCostPerOrder: 0,
                subsidyRate: 0.85  // å›½è¡¥ä¼˜æƒ ç³»æ•°
            },
            products: {},
            productOrder: [],
            selectedProduct: null,
            productCount: 0,
            // æ’åºçŠ¶æ€
            sortField: null,
            sortDirection: 'desc',  // 'asc' æˆ– 'desc'
            // æ‰¹é‡é€‰æ‹©çŠ¶æ€
            selectedProducts: new Set(),
            selectAll: false,
            // æŒ‡æ ‡é…ç½®
            columnConfig: {
                allocatedBudget: true,
                totalActualProfit: true,
                actualProfitPerOrder: true,
                costPerOrder: true,
                salesUnits: true,
                salesRevenue: true,
                platformFee: true,
                shippingRate: true,
                shippingCostPerOrder: true,
                laborCost: true,
                price: true,
                cost: true,
                clickPrice: true,
                conversionRate: true,
                roi: true,
                actualPrice: true,
                actualProfitRate: true,
                grossProfitRate: true,
                fixedCostRate: true,
                breakevenPriceIncrease: true,
                breakevenCostReduction: true
            }
        };

        // è¡¨æ ¼å¯¼å…¥ç›¸å…³å˜é‡
        let importState = {
            currentStep: 1,
            fileData: null,
            fieldMapping: {},
            previewData: []
        };

        // å­—æ®µæ˜ å°„é…ç½®
        const FIELD_MAPPINGS = {
            // äº§å“åç§°çš„å„ç§å¯èƒ½å­—æ®µå
            'ä¸»ä½“åç§°': 'name',
            'äº§å“åç§°': 'name', 
            'å•†å“åç§°': 'name',
            'åç§°': 'name',
            'å•†å“': 'name',
            'äº§å“': 'name',
            'æ ‡é¢˜': 'name',
            'title': 'name',
            'name': 'name',
            'product': 'name',
            'goods': 'name',
            
            // ç‚¹å‡»å•ä»·çš„å„ç§å¯èƒ½å­—æ®µå
            'å¹³å‡ç‚¹å‡»èŠ±è´¹': 'clickPrice',
            'ç‚¹å‡»å•ä»·': 'clickPrice',
            'ç‚¹å‡»èŠ±è´¹': 'clickPrice',
            'å¹³å‡ç‚¹å‡»ä»·æ ¼': 'clickPrice',
            'ç‚¹å‡»ä»·æ ¼': 'clickPrice',
            'æ¯æ¬¡ç‚¹å‡»è´¹ç”¨': 'clickPrice',
            'cpc': 'clickPrice',
            'click_price': 'clickPrice',
            'avg_cpc': 'clickPrice',
            'æ¨å¹¿è´¹ç”¨': 'clickPrice',
            'å¹³å‡ç‚¹å‡»æˆæœ¬': 'clickPrice',
            
            // è½¬åŒ–ç‡çš„å„ç§å¯èƒ½å­—æ®µå
            'ç‚¹å‡»è½¬åŒ–ç‡': 'conversionRate',
            'è½¬åŒ–ç‡': 'conversionRate',
            'è½¬æ¢ç‡': 'conversionRate',
            'conversion_rate': 'conversionRate',
            'cvr': 'conversionRate',
            'æˆäº¤è½¬åŒ–ç‡': 'conversionRate',
            'è®¢å•è½¬åŒ–ç‡': 'conversionRate',
            
            // æŠ•äº§æ¯”çš„å„ç§å¯èƒ½å­—æ®µå
            'æŠ•äº§æ¯”': 'roi',
            'æŠ•å…¥äº§å‡ºæ¯”': 'roi',
            'roi': 'roi',
            'roas': 'roi',
            'å›æŠ¥ç‡': 'roi',
            'äº§å‡ºæŠ•å…¥æ¯”': 'roi',
            
            // äº§å“å”®ä»·çš„å„ç§å¯èƒ½å­—æ®µå
            'äº§å“å”®ä»·': 'price',
            'å•†å“å”®ä»·': 'price',
            'å”®ä»·': 'price',
            'å•ä»·': 'price',
            'ä»·æ ¼': 'price',
            'å•†å“ä»·æ ¼': 'price',
            'äº§å“ä»·æ ¼': 'price',
            'é”€å”®ä»·æ ¼': 'price',
            'é›¶å”®ä»·': 'price',
            'price': 'price',
            'unit_price': 'price',
            'selling_price': 'price',
            'retail_price': 'price',
            'åŠç‰Œä»·': 'price',
            'æ ‡ä»·': 'price',
            
            // äº§å“æˆæœ¬çš„å„ç§å¯èƒ½å­—æ®µå
            'äº§å“æˆæœ¬': 'cost',
            'å•†å“æˆæœ¬': 'cost',
            'è¿›è´§ä»·': 'cost',
            'é‡‡è´­ä»·': 'cost',
            'ä¾›åº”å•†ä»·': 'cost',
            'åŸææ–™æˆæœ¬': 'cost',
            'ç”Ÿäº§æˆæœ¬': 'cost',
            'åˆ¶é€ æˆæœ¬': 'cost',
            'cost': 'cost',
            'product_cost': 'cost',
            'goods_cost': 'cost',
            'purchase_price': 'cost',
            'supplier_price': 'cost',
            'manufacturing_cost': 'cost'
        };

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨...');
            try {
                loadFromStorage();
                renderProductList();
                renderDataTable();
                renderStats();
                updateProductCount();
                initScrollHint();
                console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ', globalState);
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åº”ç”¨åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        // åˆå§‹åŒ–æ»šåŠ¨æç¤º
        function initScrollHint() {
            const container = document.querySelector('.table-scroll-container');
            const hint = document.getElementById('scrollHint');
            
            if (!container || !hint) return;
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ»šåŠ¨
            function checkScrollNeed() {
                const needsHorizontalScroll = container.scrollWidth > container.clientWidth;
                
                if (needsHorizontalScroll) {
                    hint.classList.remove('hidden');
                    
                    // 3ç§’åè‡ªåŠ¨éšè—æç¤º
                    setTimeout(() => {
                        hint.classList.add('hidden');
                    }, 3000);
                } else {
                    hint.classList.add('hidden');
                }
            }
            
            // æ»šåŠ¨æ—¶éšè—æç¤º
            container.addEventListener('scroll', () => {
                hint.classList.add('hidden');
            });
            
            // é¼ æ ‡è¿›å…¥è¡¨æ ¼åŒºåŸŸæ—¶æ˜¾ç¤ºæç¤º
            container.addEventListener('mouseenter', () => {
                const needsHorizontalScroll = container.scrollWidth > container.clientWidth;
                if (needsHorizontalScroll) {
                    hint.classList.remove('hidden');
                }
            });
            
            // é¼ æ ‡ç¦»å¼€è¡¨æ ¼åŒºåŸŸæ—¶éšè—æç¤º
            container.addEventListener('mouseleave', () => {
                hint.classList.add('hidden');
            });
            
            // åˆå§‹æ£€æŸ¥
            setTimeout(checkScrollNeed, 100);
            
            // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ£€æŸ¥
            window.addEventListener('resize', checkScrollNeed);
        }

        // æ·»åŠ äº§å“
        function addProduct() {
            console.log('å¼€å§‹æ·»åŠ äº§å“...');
            try {
                globalState.productCount++;
                const productId = `product_${globalState.productCount}`;
                
                globalState.products[productId] = {
                    id: productId,
                    name: `äº§å“ ${globalState.productCount}`,
                    price: 0,
                    cost: 0,
                    clickPrice: 0,
                    conversionRate: 0,
                    weight: 1, // ç”¨äºé¢„ç®—åˆ†é…
                    // ç»§æ‰¿é»˜è®¤å‚æ•°
                    ...globalState.defaultParams
                };

                globalState.productOrder.push(productId);
                
                // é‡æ–°åˆ†é…é¢„ç®—
                distributeBudget();
                
                renderProductList();
                renderDataTable();
                renderStats();
                updateProductCount();
                saveToStorage();
                
                console.log('äº§å“æ·»åŠ æˆåŠŸ:', productId, globalState.products[productId]);
            } catch (error) {
                console.error('æ·»åŠ äº§å“å¤±è´¥:', error);
                alert('æ·»åŠ äº§å“å¤±è´¥: ' + error.message);
            }
        }

        // åˆ é™¤äº§å“
        function deleteProduct(productId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº§å“å—ï¼Ÿ')) {
                delete globalState.products[productId];
                globalState.productOrder = globalState.productOrder.filter(id => id !== productId);
                
                // æ¸…ç†é€‰æ‹©çŠ¶æ€
                globalState.selectedProducts.delete(productId);
                
                if (globalState.selectedProduct === productId) {
                    globalState.selectedProduct = null;
                }
                
                renderProductList();
                renderDataTable();
                updateProductCount();
                updateBatchActionButtons();
                saveToStorage();
            }
        }

        // è¡¨æ ¼æ’åºåŠŸèƒ½
        function sortTable(field) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ’åºå­—æ®µï¼Œåˆ™åˆ‡æ¢æ’åºæ–¹å‘
            if (globalState.sortField === field) {
                globalState.sortDirection = globalState.sortDirection === 'desc' ? 'asc' : 'desc';
            } else {
                globalState.sortField = field;
                globalState.sortDirection = 'desc'; // é»˜è®¤é™åº
            }
            
            // å¯¹äº§å“è¿›è¡Œæ’åº
            globalState.productOrder.sort((aId, bId) => {
                const productA = globalState.products[aId];
                const productB = globalState.products[bId];
                const calculatedA = calculateProductData(productA);
                const calculatedB = calculateProductData(productB);
                
                let valueA = calculatedA[field];
                let valueB = calculatedB[field];
                
                // ç¡®ä¿æ•°å€¼æ¯”è¾ƒ
                valueA = typeof valueA === 'number' ? valueA : 0;
                valueB = typeof valueB === 'number' ? valueB : 0;
                
                if (globalState.sortDirection === 'desc') {
                    return valueB - valueA;
                } else {
                    return valueA - valueB;
                }
            });
            
            // æ›´æ–°æ’åºå›¾æ ‡
            updateSortIcons();
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderDataTable();
            renderProductList();
            saveToStorage();
        }
        
        // æ›´æ–°æ’åºå›¾æ ‡
        function updateSortIcons() {
            // é‡ç½®æ‰€æœ‰å›¾æ ‡
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'sort-icon';
                icon.textContent = 'â‡…';
            });
            
            // è®¾ç½®å½“å‰æ’åºå­—æ®µçš„å›¾æ ‡
            if (globalState.sortField) {
                const activeIcon = document.getElementById(`sort-${globalState.sortField}`);
                if (activeIcon) {
                    activeIcon.className = 'sort-icon active';
                    activeIcon.textContent = globalState.sortDirection === 'desc' ? 'â†“' : 'â†‘';
                }
            }
        }
        
        // æ‰¹é‡é€‰æ‹©å’Œåˆ é™¤åŠŸèƒ½
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const productCheckboxes = document.querySelectorAll('.product-checkbox');
            
            globalState.selectAll = selectAllCheckbox.checked;
            
            productCheckboxes.forEach(checkbox => {
                checkbox.checked = globalState.selectAll;
                const productId = checkbox.getAttribute('data-product-id');
                if (globalState.selectAll) {
                    globalState.selectedProducts.add(productId);
                } else {
                    globalState.selectedProducts.delete(productId);
                }
                // ç«‹å³æ›´æ–°æ¯è¡Œçš„é«˜äº®çŠ¶æ€
                updateRowHighlight(productId);
            });
            
            updateBatchActionButtons();
        }
        
        function toggleProductSelection(productId) {
            const checkbox = document.querySelector(`.product-checkbox[data-product-id="${productId}"]`);
            
            console.log('toggleProductSelection è°ƒç”¨:', productId, 'å¤é€‰æ¡†çŠ¶æ€:', checkbox ? checkbox.checked : 'æœªæ‰¾åˆ°å¤é€‰æ¡†');
            
            if (checkbox && checkbox.checked) {
                globalState.selectedProducts.add(productId);
                console.log('æ·»åŠ äº§å“åˆ°é€‰æ‹©é›†åˆ:', productId);
            } else {
                globalState.selectedProducts.delete(productId);
                console.log('ä»é€‰æ‹©é›†åˆç§»é™¤äº§å“:', productId);
            }
            
            // ç«‹å³æ›´æ–°è¡Œé«˜äº®çŠ¶æ€
            updateRowHighlight(productId);
            
            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            const selectAllCheckbox = document.getElementById('selectAll');
            const totalProducts = globalState.productOrder.length;
            const selectedCount = globalState.selectedProducts.size;
            
            if (selectedCount === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (selectedCount === totalProducts) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            }
            
            // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®
            updateBatchActionButtons();
        }
        
        // æ›´æ–°å•è¡Œé«˜äº®çŠ¶æ€
        function updateRowHighlight(productId) {
            const isSelected = globalState.selectedProducts.has(productId);
            
            // æ›´æ–°å›ºå®šåˆ—
            const fixedRow = document.querySelector(`#fixedColumnBody .table-cell[data-product-id="${productId}"]`);
            if (fixedRow) {
                if (isSelected) {
                    fixedRow.classList.add('fixed-row-selected');
                } else {
                    fixedRow.classList.remove('fixed-row-selected');
                }
            }
            
            // æ›´æ–°æ»šåŠ¨åˆ—
            const scrollableRow = document.querySelector(`#scrollableTableBody .table-row[data-product-id="${productId}"]`);
            if (scrollableRow) {
                if (isSelected) {
                    scrollableRow.classList.add('table-row-selected');
                } else {
                    scrollableRow.classList.remove('table-row-selected');
                }
            }
        }
        
        function updateBatchActionButtons() {
            const batchDeleteBtn = document.getElementById('batchDeleteBtn');
            const applyDefaultBtn = document.getElementById('applyDefaultBtn');
            const batchSetBtn = document.getElementById('batchSetBtn');
            const selectedCountSpan = document.getElementById('selectedCount');
            const applySelectedCountSpan = document.getElementById('applySelectedCount');
            const batchSetCountSpan = document.getElementById('batchSetCount');
            const selectedCount = globalState.selectedProducts.size;
            
            console.log('æ›´æ–°æ‰¹é‡æŒ‰é’®ï¼Œé€‰ä¸­äº§å“æ•°:', selectedCount, 'é€‰ä¸­çš„äº§å“:', Array.from(globalState.selectedProducts));
            
            if (selectedCount > 0) {
                // æ˜¾ç¤ºæ‰¹é‡åˆ é™¤æŒ‰é’®
                if (batchDeleteBtn) {
                    batchDeleteBtn.style.display = 'inline-flex';
                    if (selectedCountSpan) selectedCountSpan.textContent = selectedCount;
                }
                
                // æ˜¾ç¤ºåº”ç”¨é»˜è®¤é…ç½®æŒ‰é’®
                if (applyDefaultBtn) {
                    applyDefaultBtn.style.display = 'inline-flex';
                    if (applySelectedCountSpan) applySelectedCountSpan.textContent = selectedCount;
                }
                
                // æ˜¾ç¤ºæ‰¹é‡è®¾ç½®æŒ‰é’®
                if (batchSetBtn) {
                    batchSetBtn.style.display = 'inline-flex';
                    if (batchSetCountSpan) batchSetCountSpan.textContent = selectedCount;
                }
            } else {
                // éšè—æ‰€æœ‰æŒ‰é’®
                if (batchDeleteBtn) batchDeleteBtn.style.display = 'none';
                if (applyDefaultBtn) applyDefaultBtn.style.display = 'none';
                if (batchSetBtn) batchSetBtn.style.display = 'none';
            }
        }
        
        // ä¿æŒå‘åå…¼å®¹æ€§
        function updateBatchDeleteButton() {
            updateBatchActionButtons();
        }
        
        function batchDeleteProducts() {
            const selectedCount = globalState.selectedProducts.size;
            if (selectedCount === 0) return;
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedCount} ä¸ªäº§å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                // åˆ é™¤é€‰ä¸­çš„äº§å“
                globalState.selectedProducts.forEach(productId => {
                    delete globalState.products[productId];
                    globalState.productOrder = globalState.productOrder.filter(id => id !== productId);
                });
                
                // æ¸…ç©ºé€‰æ‹©çŠ¶æ€
                globalState.selectedProducts.clear();
                globalState.selectAll = false;
                
                // å¦‚æœå½“å‰é€‰ä¸­çš„äº§å“è¢«åˆ é™¤äº†ï¼Œæ¸…ç©ºé€‰æ‹©
                if (globalState.selectedProduct && !globalState.products[globalState.selectedProduct]) {
                    globalState.selectedProduct = null;
                }
                
                // é‡æ–°æ¸²æŸ“
                renderProductList();
                renderDataTable();
                updateProductCount();
                updateBatchActionButtons();
                saveToStorage();
            }
        }
        
        // æ‰¹é‡è®¾ç½®åŠŸèƒ½
        function openBatchSettings() {
            const selectedCount = globalState.selectedProducts.size;
            if (selectedCount === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦è®¾ç½®çš„äº§å“ï¼');
                return;
            }
            
            // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„äº§å“æ•°é‡æ˜¾ç¤º
            document.getElementById('batchSettingsCount').textContent = selectedCount;
            
            // æ¸…ç©ºè¡¨å•
            clearBatchForm();
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('batchSettingsModal').style.display = 'flex';
        }
        
        function closeBatchSettings() {
            document.getElementById('batchSettingsModal').style.display = 'none';
        }
        
        function clearBatchForm() {
            document.getElementById('batchPlatformFee').value = '';
            document.getElementById('batchShippingRate').value = '';
            document.getElementById('batchLaborCost').value = '';
            document.getElementById('batchSubsidyRate').value = '';
            document.getElementById('batchShippingCostPerOrder').value = '';
            document.getElementById('batchWeight').value = '';
        }
        
        function applyBatchSettings() {
            const selectedCount = globalState.selectedProducts.size;
            if (selectedCount === 0) {
                alert('æ²¡æœ‰é€‰ä¸­çš„äº§å“ï¼');
                return;
            }
            
            // è·å–è¡¨å•æ•°æ®
            const batchData = {
                platformFee: parseFloat(document.getElementById('batchPlatformFee').value) || null,
                shippingRate: parseFloat(document.getElementById('batchShippingRate').value) || null,
                laborCost: parseFloat(document.getElementById('batchLaborCost').value) || null,
                subsidyRate: parseFloat(document.getElementById('batchSubsidyRate').value) || null,
                shippingCostPerOrder: parseFloat(document.getElementById('batchShippingCostPerOrder').value) || null,
                weight: parseFloat(document.getElementById('batchWeight').value) || null
            };
            
            // æ£€æŸ¥æ˜¯å¦æœ‰è®¾ç½®é¡¹
            const hasSettings = Object.values(batchData).some(value => value !== null);
            if (!hasSettings) {
                alert('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªè¦è®¾ç½®çš„å‚æ•°ï¼');
                return;
            }
            
            // åˆ›å»ºè®¾ç½®æ‘˜è¦
            let settingSummary = [];
            if (batchData.platformFee !== null) settingSummary.push(`å•†åŸæ‰£ç‚¹ï¼š${batchData.platformFee}%`);
            if (batchData.shippingRate !== null) settingSummary.push(`è¿è´¹å æ¯”ï¼š${batchData.shippingRate}%`);
            if (batchData.laborCost !== null) settingSummary.push(`äººå‘˜å¼€é”€ï¼š${batchData.laborCost}%`);
            if (batchData.subsidyRate !== null) settingSummary.push(`å›½è¡¥ä¼˜æƒ ç³»æ•°ï¼š${batchData.subsidyRate}`);
            if (batchData.shippingCostPerOrder !== null) settingSummary.push(`æ¯å•è¿è´¹ï¼šÂ¥${batchData.shippingCostPerOrder}`);
            if (batchData.weight !== null) settingSummary.push(`äº§å“æƒé‡ï¼š${batchData.weight}`);
            
            // ç¡®è®¤å¯¹è¯æ¡†
            const confirmMessage = `ç¡®å®šè¦å¯¹é€‰ä¸­çš„ ${selectedCount} ä¸ªäº§å“æ‰¹é‡è®¾ç½®ä»¥ä¸‹å‚æ•°å—ï¼Ÿ\n\n${settingSummary.join('\n')}\n\næ³¨æ„ï¼šç©ºç™½å­—æ®µå°†ä¿æŒäº§å“å½“å‰å€¼ä¸å˜ã€‚`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            let updatedCount = 0;
            
            // å¯¹é€‰ä¸­çš„äº§å“åº”ç”¨è®¾ç½®
            globalState.selectedProducts.forEach(productId => {
                if (globalState.products[productId]) {
                    const product = globalState.products[productId];
                    
                    // åº”ç”¨éç©ºçš„è®¾ç½®é¡¹
                    if (batchData.platformFee !== null) {
                        product.platformFee = batchData.platformFee;
                    }
                    if (batchData.shippingRate !== null) {
                        product.shippingRate = batchData.shippingRate;
                    }
                    if (batchData.laborCost !== null) {
                        product.laborCost = batchData.laborCost;
                    }
                    if (batchData.subsidyRate !== null) {
                        product.subsidyRate = batchData.subsidyRate;
                    }
                    if (batchData.shippingCostPerOrder !== null) {
                        product.shippingCostPerOrder = batchData.shippingCostPerOrder;
                    }
                    if (batchData.weight !== null) {
                        product.weight = batchData.weight;
                    }
                    
                    // å¤„ç†è¿è´¹è”åŠ¨è®¡ç®—
                    if (batchData.shippingRate !== null || batchData.shippingCostPerOrder !== null) {
                        if (batchData.shippingRate !== null && product.price > 0) {
                            // æ ¹æ®è¿è´¹å æ¯”è®¡ç®—æ¯å•è¿è´¹
                            if (batchData.shippingCostPerOrder === null) {
                                product.shippingCostPerOrder = (product.price * batchData.shippingRate) / 100;
                            }
                        } else if (batchData.shippingCostPerOrder !== null && product.price > 0) {
                            // æ ¹æ®æ¯å•è¿è´¹è®¡ç®—è¿è´¹å æ¯”
                            if (batchData.shippingRate === null) {
                                product.shippingRate = (batchData.shippingCostPerOrder / product.price) * 100;
                            }
                        }
                    }
                    
                    updatedCount++;
                }
            });
            
            // é‡æ–°åˆ†é…é¢„ç®—ï¼ˆå¦‚æœè®¾ç½®äº†æƒé‡ï¼‰
            if (batchData.weight !== null) {
                distributeBudget();
            }
            
            // é‡æ–°æ¸²æŸ“ç•Œé¢
            renderProductList();
            renderDataTable();
            renderStats();
            saveToStorage();
            
            // å…³é—­æ¨¡æ€æ¡†
            closeBatchSettings();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert(`æˆåŠŸæ‰¹é‡è®¾ç½® ${updatedCount} ä¸ªäº§å“çš„å‚æ•°ï¼\n\nè®¾ç½®é¡¹ï¼š\n${settingSummary.join('\n')}`);
        }

        // åº”ç”¨é»˜è®¤é…ç½®åˆ°é€‰ä¸­çš„äº§å“
        function applyDefaultConfig() {
            const selectedCount = globalState.selectedProducts.size;
            if (selectedCount === 0) return;
            
            if (confirm(`ç¡®å®šè¦å°†é»˜è®¤é…ç½®åº”ç”¨åˆ°é€‰ä¸­çš„ ${selectedCount} ä¸ªäº§å“å—ï¼Ÿ\n\nå°†åº”ç”¨ä»¥ä¸‹é»˜è®¤é…ç½®ï¼š\nâ€¢ å•†åŸæ‰£ç‚¹ï¼š${globalState.defaultParams.platformFee}%\nâ€¢ è¿è´¹å æ¯”ï¼š${globalState.defaultParams.shippingRate}%\nâ€¢ äººå‘˜å¼€é”€ï¼š${globalState.defaultParams.laborCost}%\nâ€¢ å›½è¡¥ä¼˜æƒ ç³»æ•°ï¼š${globalState.defaultParams.subsidyRate}`)) {
                
                let appliedCount = 0;
                
                // å¯¹é€‰ä¸­çš„äº§å“åº”ç”¨é»˜è®¤é…ç½®
                globalState.selectedProducts.forEach(productId => {
                    if (globalState.products[productId]) {
                        const product = globalState.products[productId];
                        
                        // åº”ç”¨é»˜è®¤å‚æ•°ï¼Œä½†ä¿ç•™äº§å“ç‰¹æœ‰æ•°æ®
                        product.platformFee = globalState.defaultParams.platformFee;
                        product.shippingRate = globalState.defaultParams.shippingRate;
                        product.laborCost = globalState.defaultParams.laborCost;
                        product.subsidyRate = globalState.defaultParams.subsidyRate;
                        
                        // é‡æ–°è®¡ç®—è¿è´¹ï¼ˆå¦‚æœæœ‰è®¾ç½®æ¯å•è¿è´¹ï¼‰
                        if (product.shippingCostPerOrder > 0 && product.price > 0) {
                            product.shippingRate = (product.shippingCostPerOrder / product.price) * 100;
                        } else if (product.shippingRate > 0 && product.price > 0) {
                            product.shippingCostPerOrder = (product.price * product.shippingRate) / 100;
                        }
                        
                        appliedCount++;
                    }
                });
                
                // é‡æ–°åˆ†é…é¢„ç®—
                distributeBudget();
                
                // é‡æ–°æ¸²æŸ“ç•Œé¢
                renderProductList();
                renderDataTable();
                renderStats();
                saveToStorage();
                
                alert(`æˆåŠŸåº”ç”¨é»˜è®¤é…ç½®åˆ° ${appliedCount} ä¸ªäº§å“ï¼`);
            }
        }
        
        // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
        function updateCheckboxStates() {
            // æ›´æ–°äº§å“å¤é€‰æ¡†çŠ¶æ€
            const productCheckboxes = document.querySelectorAll('.product-checkbox');
            productCheckboxes.forEach(checkbox => {
                const productId = checkbox.getAttribute('data-product-id');
                if (productId) {
                    checkbox.checked = globalState.selectedProducts.has(productId);
                    // ç«‹å³æ›´æ–°è¡Œé«˜äº®çŠ¶æ€
                    updateRowHighlight(productId);
                }
            });
            
            // æ›´æ–°å…¨é€‰å¤é€‰æ¡†çŠ¶æ€
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                const totalProducts = globalState.productOrder.length;
                const selectedCount = globalState.selectedProducts.size;
                
                if (selectedCount === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = false;
                } else if (selectedCount === totalProducts) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.indeterminate = false;
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.indeterminate = true;
                }
            }
            
            // æ›´æ–°æ‰¹é‡æ“ä½œæŒ‰é’®
            updateBatchActionButtons();
        }

        // ç”Ÿæˆè®¡ç®—å…¬å¼è¯´æ˜çš„å·¥å…·æç¤ºæ–‡æœ¬
        function getTooltipText(field, product, calculated) {
            const tooltips = {
                allocatedBudget: "æ¨å¹¿é¢„ç®—\n\næ ¹æ®é¢„ç®—åˆ†é…æ–¹å¼ç¡®å®šï¼š\nâ€¢ æ¯åº—æ¨å¹¿é¢„ç®—æ€»é¢ï¼šæ¯ä¸ªäº§å“ä½¿ç”¨å…¨éƒ¨é¢„ç®—\nâ€¢ å¹³å‡åˆ†é…ï¼šæ€»é¢„ç®— Ã· äº§å“æ•°é‡\nâ€¢ æŒ‰æƒé‡åˆ†é…ï¼šæ€»é¢„ç®— Ã— (äº§å“æƒé‡ Ã· æ€»æƒé‡)\nâ€¢ æ‰‹åŠ¨åˆ†é…ï¼šç”¨æˆ·è‡ªå®šä¹‰è®¾ç½®",
                
                totalActualProfit: `æ¨å¹¿å®é™…åˆ©æ¶¦ = æ¨å¹¿é”€å”®å•æ•° Ã— æ¯å•å®é™…åˆ©æ¶¦\n\nè®¡ç®—è¿‡ç¨‹ï¼š\né”€å”®å•æ•°ï¼š${calculated.salesUnits.toFixed(0)} å•\næ¯å•å®é™…åˆ©æ¶¦ï¼šÂ¥${calculated.actualProfitPerOrder.toFixed(2)}\nå®é™…åˆ©æ¶¦ï¼š${calculated.salesUnits.toFixed(0)} Ã— ${calculated.actualProfitPerOrder.toFixed(2)} = Â¥${calculated.totalActualProfit.toFixed(2)}`,
                
                actualProfitPerOrder: `æ¯å•å®é™…åˆ©æ¶¦ = å•ä½åˆ©æ¶¦ - æˆäº¤æ¯å•æˆæœ¬\n\nè®¡ç®—è¿‡ç¨‹ï¼š\nå•ä½åˆ©æ¶¦ï¼šÂ¥${calculated.unitProfit.toFixed(2)}\næˆäº¤æ¯å•æˆæœ¬ï¼šÂ¥${calculated.costPerOrder.toFixed(2)}\næ¯å•å®é™…åˆ©æ¶¦ï¼š${calculated.unitProfit.toFixed(2)} - ${calculated.costPerOrder.toFixed(2)} = Â¥${calculated.actualProfitPerOrder.toFixed(2)}`,
                
                costPerOrder: `æˆäº¤æ¯å•æˆæœ¬ = ç‚¹å‡»å•ä»· Ã· è½¬åŒ–ç‡\n\nè®¡ç®—è¿‡ç¨‹ï¼š\nç‚¹å‡»å•ä»·ï¼šÂ¥${product.clickPrice}\nè½¬åŒ–ç‡ï¼š${product.conversionRate}%\næˆäº¤æ¯å•æˆæœ¬ï¼š${product.clickPrice} Ã· ${product.conversionRate/100} = Â¥${calculated.costPerOrder.toFixed(2)}`,
                
                salesUnits: `æ¨å¹¿é”€å”®å•æ•° = (æ¨å¹¿é¢„ç®— Ã· ç‚¹å‡»å•ä»·) Ã— è½¬åŒ–ç‡\n\nè®¡ç®—è¿‡ç¨‹ï¼š\næ¨å¹¿é¢„ç®—ï¼šÂ¥${(product.allocatedBudget || 0).toFixed(2)}\nç‚¹å‡»å•ä»·ï¼šÂ¥${product.clickPrice}\nè½¬åŒ–ç‡ï¼š${product.conversionRate}%\né”€å”®å•æ•°ï¼š(${(product.allocatedBudget || 0).toFixed(2)} Ã· ${product.clickPrice}) Ã— ${product.conversionRate/100} = ${calculated.salesUnits.toFixed(0)} å•`,
                
                salesRevenue: `æ¨å¹¿é”€å”®é¢ = æ¨å¹¿é”€å”®å•æ•° Ã— å®é™…å”®ä»·\n\nè®¡ç®—è¿‡ç¨‹ï¼š\næ¨å¹¿é”€å”®å•æ•°ï¼š${calculated.salesUnits.toFixed(0)} å•\nå®é™…å”®ä»·ï¼šÂ¥${calculated.actualPrice.toFixed(2)}\næ¨å¹¿é”€å”®é¢ï¼š${calculated.salesUnits.toFixed(0)} Ã— ${calculated.actualPrice.toFixed(2)} = Â¥${calculated.salesRevenue.toFixed(2)}`,
                
                platformFee: `å•†åŸæ‰£ç‚¹\n\nå¹³å°æ”¶å–çš„äº¤æ˜“æ‰‹ç»­è´¹ç™¾åˆ†æ¯”\nå½“å‰è®¾ç½®ï¼š${product.platformFee}%\n\nå½±å“å®é™…åˆ©æ¶¦ç‡è®¡ç®—`,
                
                shippingRate: `è¿è´¹å æ¯”\n\nè¿è´¹å å®é™…å”®ä»·çš„ç™¾åˆ†æ¯”\nå½“å‰è®¾ç½®ï¼š${product.shippingRate}%\n\nä¸æ¯å•è¿è´¹è”åŠ¨ï¼š\nè¿è´¹å æ¯” = æ¯å•è¿è´¹ Ã· å®é™…å”®ä»· Ã— 100%`,
                
                shippingCostPerOrder: `æ¯å•è¿è´¹\n\næ¯ç¬”è®¢å•çš„è¿è´¹é‡‘é¢\nå½“å‰è®¾ç½®ï¼šÂ¥${product.shippingCostPerOrder}\n\nä¸è¿è´¹å æ¯”è”åŠ¨ï¼š\næ¯å•è¿è´¹ = å®é™…å”®ä»· Ã— è¿è´¹å æ¯” Ã· 100%`,
                
                laborCost: `äººå‘˜å¼€é”€\n\näººåŠ›æˆæœ¬å å®é™…å”®ä»·çš„ç™¾åˆ†æ¯”\nå½“å‰è®¾ç½®ï¼š${product.laborCost}%\n\nåŒ…æ‹¬å®¢æœã€è¿è¥ã€åŒ…è£…ç­‰äººåŠ›æˆæœ¬`,
                
                price: `äº§å“å”®ä»·\n\näº§å“çš„æ ‡å‡†é”€å”®ä»·æ ¼\nå½“å‰è®¾ç½®ï¼šÂ¥${product.price}\n\næ³¨æ„ï¼šå®é™…æ”¶å…¥ä»¥"å®é™…å”®ä»·"ä¸ºå‡†\n(è€ƒè™‘å›½è¡¥ä¼˜æƒ ç­‰å› ç´ )`,
                
                cost: `äº§å“æˆæœ¬\n\näº§å“çš„é‡‡è´­æˆ–ç”Ÿäº§æˆæœ¬\nå½“å‰è®¾ç½®ï¼šÂ¥${product.cost}\n\nç”¨äºè®¡ç®—å„ç§åˆ©æ¶¦ç‡æŒ‡æ ‡`,
                
                clickPrice: `ç‚¹å‡»å•ä»·\n\næ¨å¹¿ä¸­æ¯æ¬¡ç‚¹å‡»çš„å¹³å‡è´¹ç”¨\nå½“å‰è®¾ç½®ï¼šÂ¥${product.clickPrice}\n\nä¹Ÿç§°ä¸ºCPC (Cost Per Click)`,
                
                conversionRate: `è½¬åŒ–ç‡\n\nç‚¹å‡»è½¬åŒ–ä¸ºè´­ä¹°çš„æ¯”ä¾‹\nå½“å‰è®¾ç½®ï¼š${product.conversionRate}%\n\nè½¬åŒ–ç‡ = è®¢å•æ•° Ã· ç‚¹å‡»æ•° Ã— 100%`,
                
                roi: `æŠ•äº§æ¯” (ROI)\n\næŠ•å…¥äº§å‡ºæ¯”ï¼Œè¡¡é‡æ¨å¹¿æ•ˆæœ\nè®¡ç®—å…¬å¼ï¼šæŠ•äº§æ¯” = (äº§å“å”®ä»· Ã— è½¬åŒ–ç‡) Ã· ç‚¹å‡»å•ä»·\n\nè®¡ç®—è¿‡ç¨‹ï¼š\näº§å“å”®ä»·ï¼šÂ¥${product.price}\nè½¬åŒ–ç‡ï¼š${product.conversionRate}%\nç‚¹å‡»å•ä»·ï¼šÂ¥${product.clickPrice}\nROIï¼š(${product.price} Ã— ${product.conversionRate/100}) Ã· ${product.clickPrice} = ${calculated.roi.toFixed(2)}`,
                
                actualPrice: `å®é™…å”®ä»· = ROI Ã— ç‚¹å‡»å•ä»· Ã· è½¬åŒ–ç‡ Ã— å›½è¡¥ä¼˜æƒ ç³»æ•°\n\nè®¡ç®—è¿‡ç¨‹ï¼š\nROIï¼š${calculated.roi.toFixed(2)}\nç‚¹å‡»å•ä»·ï¼šÂ¥${product.clickPrice}\nè½¬åŒ–ç‡ï¼š${product.conversionRate}%\nå›½è¡¥ä¼˜æƒ ç³»æ•°ï¼š${globalState.defaultParams.subsidyRate || 0.85}\n\nå®é™…å”®ä»·ï¼š${calculated.roi.toFixed(2)} Ã— ${product.clickPrice} Ã· ${product.conversionRate/100} Ã— ${globalState.defaultParams.subsidyRate || 0.85} = Â¥${calculated.actualPrice.toFixed(2)}\n\nè¿™æ˜¯ç”¨æˆ·å®é™…æ”¶åˆ°çš„å•ä»·`,
                
                actualProfitRate: `å®é™…åˆ©æ¶¦ç‡ = å®é™…æ¯›åˆ©æ¶¦ç‡ - å•†åŸæ‰£ç‚¹ - è¿è´¹å æ¯” - äººå‘˜å¼€é”€\n\nè®¡ç®—è¿‡ç¨‹ï¼š\nå®é™…æ¯›åˆ©æ¶¦ç‡ï¼š${(calculated.actualGrossProfitRate * 100).toFixed(1)}%\nå•†åŸæ‰£ç‚¹ï¼š${product.platformFee}%\nè¿è´¹å æ¯”ï¼š${(calculated.shippingRateActual * 100).toFixed(1)}%\näººå‘˜å¼€é”€ï¼š${product.laborCost}%\n\nå®é™…åˆ©æ¶¦ç‡ï¼š${(calculated.actualGrossProfitRate * 100).toFixed(1)}% - ${product.platformFee}% - ${(calculated.shippingRateActual * 100).toFixed(1)}% - ${product.laborCost}% = ${(calculated.actualProfitRate * 100).toFixed(1)}%`,
                
                grossProfitRate: `å”®ä»·åˆ©æ¶¦ç‡ = (å®é™…å”®ä»· - äº§å“æˆæœ¬) Ã· å®é™…å”®ä»· Ã— 100%\n\nè®¡ç®—è¿‡ç¨‹ï¼š\nå®é™…å”®ä»·ï¼šÂ¥${calculated.actualPrice.toFixed(2)}\näº§å“æˆæœ¬ï¼šÂ¥${product.cost}\nå”®ä»·åˆ©æ¶¦ç‡ï¼š(${calculated.actualPrice.toFixed(2)} - ${product.cost}) Ã· ${calculated.actualPrice.toFixed(2)} Ã— 100% = ${(calculated.actualGrossProfitRate * 100).toFixed(1)}%\n\nè¿™æ˜¯åŸºäºå®é™…å”®ä»·çš„æ¯›åˆ©æ¶¦ç‡`,
                
                fixedCostRate: `ä¿æœ¬åˆ©æ¶¦ç‡ = å•†åŸæ‰£ç‚¹ + è¿è´¹å æ¯” + äººå‘˜å¼€é”€\n\nè®¡ç®—è¿‡ç¨‹ï¼š\nå•†åŸæ‰£ç‚¹ï¼š${product.platformFee}%\nè¿è´¹å æ¯”ï¼š${(calculated.shippingRateActual * 100).toFixed(1)}%\näººå‘˜å¼€é”€ï¼š${product.laborCost}%\n\nä¿æœ¬åˆ©æ¶¦ç‡ï¼š${product.platformFee}% + ${(calculated.shippingRateActual * 100).toFixed(1)}% + ${product.laborCost}% = ${(calculated.fixedCostRate * 100).toFixed(1)}%\n\nè¦ç›ˆåˆ©ï¼Œå”®ä»·åˆ©æ¶¦ç‡å¿…é¡»è¶…è¿‡æ­¤å€¼`,
                
                breakevenPriceIncrease: calculated.breakevenPriceIncrease >= 0 ? 
                    `æ¶¨ä»·ä¿æœ¬ï¼šéœ€è¦æ¶¨ä»· Â¥${calculated.breakevenPriceIncrease.toFixed(2)} è¾¾åˆ°ç›ˆäºå¹³è¡¡\n\nä¿æœ¬å”®ä»·è®¡ç®—ï¼š\nä¿æœ¬å”®ä»· = (äº§å“æˆæœ¬ + æˆäº¤æ¯å•æˆæœ¬) Ã· (1 - å›ºå®šæˆæœ¬ç‡)\n\nè®¡ç®—è¿‡ç¨‹ï¼š\näº§å“æˆæœ¬ï¼šÂ¥${product.cost}\næˆäº¤æ¯å•æˆæœ¬ï¼šÂ¥${calculated.costPerOrder.toFixed(2)}\nå›ºå®šæˆæœ¬ç‡ï¼š${(calculated.fixedCostRate * 100).toFixed(1)}%\n\nä¿æœ¬å”®ä»·ï¼š(${product.cost} + ${calculated.costPerOrder.toFixed(2)}) Ã· (1 - ${calculated.fixedCostRate.toFixed(3)}) = Â¥${(calculated.actualPrice + calculated.breakevenPriceIncrease).toFixed(2)}\næ¶¨ä»·é‡‘é¢ï¼š${(calculated.actualPrice + calculated.breakevenPriceIncrease).toFixed(2)} - ${calculated.actualPrice.toFixed(2)} = +Â¥${calculated.breakevenPriceIncrease.toFixed(2)}` :
                    `å·²ç»ç›ˆåˆ©ï¼šå½“å‰å”®ä»·å·²è¶…è¿‡ä¿æœ¬ç‚¹ Â¥${Math.abs(calculated.breakevenPriceIncrease).toFixed(2)}\n\nå½“å‰å®é™…å”®ä»·ï¼šÂ¥${calculated.actualPrice.toFixed(2)}\nç†è®ºä¿æœ¬å”®ä»·ï¼šÂ¥${(calculated.actualPrice + calculated.breakevenPriceIncrease).toFixed(2)}\nè¶…å‡ºä¿æœ¬ç‚¹ï¼šÂ¥${Math.abs(calculated.breakevenPriceIncrease).toFixed(2)}`,
                
                breakevenCostReduction: calculated.breakevenCostReduction >= 0 ?
                    `é™æœ¬ä¿æœ¬ï¼šéœ€è¦é™ä½æˆæœ¬ Â¥${calculated.breakevenCostReduction.toFixed(2)} è¾¾åˆ°ç›ˆäºå¹³è¡¡\n\nä¿æœ¬æˆæœ¬è®¡ç®—ï¼š\nä¿æœ¬æˆæœ¬ = å®é™…å”®ä»· Ã— (1 - å›ºå®šæˆæœ¬ç‡) - æˆäº¤æ¯å•æˆæœ¬\n\nè®¡ç®—è¿‡ç¨‹ï¼š\nå®é™…å”®ä»·ï¼šÂ¥${calculated.actualPrice.toFixed(2)}\nå›ºå®šæˆæœ¬ç‡ï¼š${(calculated.fixedCostRate * 100).toFixed(1)}%\næˆäº¤æ¯å•æˆæœ¬ï¼šÂ¥${calculated.costPerOrder.toFixed(2)}\n\nä¿æœ¬æˆæœ¬ï¼š${calculated.actualPrice.toFixed(2)} Ã— (1 - ${calculated.fixedCostRate.toFixed(3)}) - ${calculated.costPerOrder.toFixed(2)} = Â¥${(product.cost - calculated.breakevenCostReduction).toFixed(2)}\né™æœ¬é‡‘é¢ï¼š${product.cost} - ${(product.cost - calculated.breakevenCostReduction).toFixed(2)} = -Â¥${calculated.breakevenCostReduction.toFixed(2)}` :
                    `æˆæœ¬å·²ä¼˜åŒ–ï¼šå½“å‰æˆæœ¬å·²ä½äºä¿æœ¬ç‚¹ Â¥${Math.abs(calculated.breakevenCostReduction).toFixed(2)}\n\nå½“å‰äº§å“æˆæœ¬ï¼šÂ¥${product.cost}\nç†è®ºä¿æœ¬æˆæœ¬ï¼šÂ¥${(product.cost - calculated.breakevenCostReduction).toFixed(2)}\næˆæœ¬ä¼˜åŒ–ç©ºé—´ï¼šÂ¥${Math.abs(calculated.breakevenCostReduction).toFixed(2)}`
            };
            
            return tooltips[field] || "æš‚æ— è®¡ç®—è¯´æ˜";
        }

        // é€‰æ‹©äº§å“
        function selectProduct(productId) {
            const previousSelected = globalState.selectedProduct;
            globalState.selectedProduct = productId;
            
            // ç«‹å³æ›´æ–°é«˜äº®çŠ¶æ€
            updateProductActiveState(previousSelected, productId);
            
            renderProductList();
        }
        
        // æ›´æ–°äº§å“çš„å•é€‰é«˜äº®çŠ¶æ€
        function updateProductActiveState(previousProductId, currentProductId) {
            // ç§»é™¤ä¹‹å‰é€‰ä¸­äº§å“çš„é«˜äº®
            if (previousProductId) {
                const prevFixedRow = document.querySelector(`#fixedColumnBody .table-cell[data-product-id="${previousProductId}"]`);
                const prevScrollableRow = document.querySelector(`#scrollableTableBody .table-row[data-product-id="${previousProductId}"]`);
                
                if (prevFixedRow) {
                    prevFixedRow.classList.remove('fixed-row-active');
                }
                if (prevScrollableRow) {
                    prevScrollableRow.classList.remove('table-row-active');
                }
            }
            
            // æ·»åŠ å½“å‰é€‰ä¸­äº§å“çš„é«˜äº®
            if (currentProductId) {
                const currentFixedRow = document.querySelector(`#fixedColumnBody .table-cell[data-product-id="${currentProductId}"]`);
                const currentScrollableRow = document.querySelector(`#scrollableTableBody .table-row[data-product-id="${currentProductId}"]`);
                
                if (currentFixedRow) {
                    currentFixedRow.classList.add('fixed-row-active');
                }
                if (currentScrollableRow) {
                    currentScrollableRow.classList.add('table-row-active');
                }
            }
        }

        // æ›´æ–°äº§å“æ•°æ®
        function updateProduct(productId, field, value) {
            if (globalState.products[productId]) {
                if (field === 'name') {
                    globalState.products[productId][field] = value;
                } else {
                    const numValue = parseFloat(value) || 0;
                    globalState.products[productId][field] = numValue;
                    
                    // è¿è´¹å’Œè¿è´¹å æ¯”è”åŠ¨è®¡ç®—
                    if (field === 'shippingRate' || field === 'shippingCostPerOrder') {
                        calculateShippingFields(productId, field, numValue);
                    } else if (field === 'price') {
                        // å”®ä»·æ”¹å˜æ—¶ï¼Œæ ¹æ®å½“å‰è¿è´¹å æ¯”é‡æ–°è®¡ç®—æ¯å•è¿è´¹
                        calculateShippingFields(productId, 'shippingRate', globalState.products[productId].shippingRate);
                    }
                }
                distributeBudget();
                renderProductList();
                renderDataTable();
                renderStats();
                saveToStorage();
            }
        }
        
        // è¿è´¹å­—æ®µè”åŠ¨è®¡ç®—
        function calculateShippingFields(productId, changedField, value) {
            const product = globalState.products[productId];
            
            if (changedField === 'shippingRate' && value > 0 && product.price > 0) {
                // è¿è´¹å æ¯”æ”¹å˜ï¼Œè®¡ç®—æ¯å•è¿è´¹
                product.shippingCostPerOrder = (product.price * value) / 100;
            } else if (changedField === 'shippingCostPerOrder' && value > 0 && product.price > 0) {
                // æ¯å•è¿è´¹æ”¹å˜ï¼Œè®¡ç®—è¿è´¹å æ¯”
                product.shippingRate = (value / product.price) * 100;
            }
        }

        // æ›´æ–°å…¨å±€é¢„ç®—
        function updateGlobalBudget() {
            globalState.promotionBudget = parseFloat(document.getElementById('globalPromotionBudget').value) || 0;
            distributeBudget();
            renderDataTable();
            renderStats();
            saveToStorage();
        }

        // æ›´æ–°é¢„ç®—åˆ†é…æ–¹å¼
        function updateBudgetAllocation() {
            globalState.budgetAllocation = document.getElementById('budgetAllocation').value;
            distributeBudget();
            renderDataTable();
            saveToStorage();
        }

        // åˆ†é…é¢„ç®—
        function distributeBudget() {
            const totalProducts = globalState.productOrder.length;
            if (totalProducts === 0) return;

            const totalBudget = globalState.promotionBudget;

            switch (globalState.budgetAllocation) {
                case 'each_full':
                    // æ¯åº—æ¨å¹¿é¢„ç®—æ€»é¢ - æ¯ä¸ªäº§å“éƒ½ä½¿ç”¨å…¨éƒ¨é¢„ç®—
                    globalState.productOrder.forEach(productId => {
                        globalState.products[productId].allocatedBudget = totalBudget;
                    });
                    break;
                    
                case 'equal':
                    // å¹³å‡åˆ†é…
                    const budgetPerProduct = totalBudget / totalProducts;
                    globalState.productOrder.forEach(productId => {
                        globalState.products[productId].allocatedBudget = budgetPerProduct;
                    });
                    break;
                
                case 'weighted':
                    // æŒ‰æƒé‡åˆ†é…
                    const totalWeight = globalState.productOrder.reduce((sum, productId) => {
                        return sum + (globalState.products[productId].weight || 1);
                    }, 0);
                    
                    globalState.productOrder.forEach(productId => {
                        const weight = globalState.products[productId].weight || 1;
                        globalState.products[productId].allocatedBudget = totalBudget * (weight / totalWeight);
                    });
                    break;
                
                case 'manual':
                    // æ‰‹åŠ¨åˆ†é…æ—¶ä¸è‡ªåŠ¨æ›´æ–°
                    break;
            }
        }

        // æ›´æ–°é»˜è®¤å‚æ•°
        function updateDefaultParams() {
            globalState.defaultParams = {
                platformFee: parseFloat(document.getElementById('defaultPlatformFee').value) || 0,
                shippingRate: parseFloat(document.getElementById('defaultShippingRate').value) || 0,
                laborCost: parseFloat(document.getElementById('defaultLaborCost').value) || 0,
                shippingCostPerOrder: 0,
                subsidyRate: parseFloat(document.getElementById('defaultSubsidyRate').value) || 0.85
            };
            saveToStorage();
        }

        // è®¡ç®—äº§å“æ•°æ®
        function calculateProductData(product) {
            const { price, cost, clickPrice, conversionRate, platformFee, shippingRate, laborCost, shippingCostPerOrder, subsidyRate } = product;
            const convRate = conversionRate / 100;
            const subsidy = subsidyRate || globalState.defaultParams.subsidyRate || 0.85;
            
            // åŸºç¡€è®¡ç®—
            const costPerOrder = convRate > 0 ? clickPrice / convRate : 0;
            const roi = clickPrice > 0 ? (price * convRate) / clickPrice : 0;
            
            // å®é™…å”®ä»·è®¡ç®—ï¼šROI Ã— ç‚¹å‡»å•ä»· Ã· ç‚¹å‡»è½¬åŒ–ç‡ Ã— å›½è¡¥ä¼˜æƒ ç³»æ•°
            const actualPrice = roi && clickPrice && convRate > 0 ? 
                (roi * clickPrice / convRate) * subsidy : 
                price * subsidy;
            
            // åŸºäºåŸå§‹äº§å“å”®ä»·çš„åˆ©æ¶¦ç‡è®¡ç®—
            const grossProfitRate = price > 0 ? (price - cost) / price : 0;
            
            // åŸºäºå®é™…å”®ä»·çš„åˆ©æ¶¦ç‡è®¡ç®—
            const actualGrossProfitRate = actualPrice > 0 ? (actualPrice - cost) / actualPrice : 0;
            
            // è¿è´¹è®¡ç®— - åŸºäºå®é™…å”®ä»·
            const shippingRateActual = shippingCostPerOrder > 0 ? 
                shippingCostPerOrder / actualPrice : 
                shippingRate / 100;
            
            // åˆ©æ¶¦è®¡ç®— - åŸºäºå®é™…å”®ä»·
            const actualProfitRate = actualGrossProfitRate - platformFee/100 - shippingRateActual - laborCost/100;
            const unitProfit = actualPrice * actualProfitRate;
            const actualProfitPerOrder = unitProfit - costPerOrder;
            
            // ä¿æœ¬åˆ†æ - åŸºäºå®é™…å”®ä»·
            const fixedCostRate = platformFee/100 + shippingRateActual + laborCost/100;
            const customerAcquisitionCost = convRate > 0 ? clickPrice / convRate : 0;
            
            let breakevenPriceIncrease = 0;
            if (fixedCostRate < 1 && (cost > 0 || customerAcquisitionCost > 0)) {
                const breakevenPrice = (cost + customerAcquisitionCost) / (1 - fixedCostRate);
                breakevenPriceIncrease = breakevenPrice - actualPrice;  // åŸºäºå®é™…å”®ä»·
            }
            
            let breakevenCostReduction = 0;
            if (actualPrice > 0) {
                const breakevenCost = actualPrice * (1 - fixedCostRate) - customerAcquisitionCost;  // åŸºäºå®é™…å”®ä»·
                breakevenCostReduction = cost - breakevenCost;
            }
            
            // æ¨å¹¿åˆ†æ - åŸºäºå®é™…å”®ä»·
            const allocatedBudget = product.allocatedBudget || 0;
            const salesUnits = clickPrice > 0 && convRate > 0 ? (allocatedBudget / clickPrice) * convRate : 0;
            const salesRevenue = salesUnits * actualPrice;  // åŸºäºå®é™…å”®ä»·
            const totalActualProfit = salesUnits * actualProfitPerOrder;
            const promotionROI = allocatedBudget > 0 ? totalActualProfit / allocatedBudget : 0;

            return {
                costPerOrder,
                roi,
                actualPrice,
                grossProfitRate,
                actualGrossProfitRate,
                shippingRateActual,
                actualProfitRate,
                unitProfit,
                actualProfitPerOrder,
                breakevenPriceIncrease,
                breakevenCostReduction,
                salesUnits,
                salesRevenue,
                totalActualProfit,
                promotionROI,
                fixedCostRate
            };
        }

        // æ¸²æŸ“äº§å“åˆ—è¡¨
        function renderProductList() {
            const container = document.getElementById('productList');
            container.innerHTML = '';

            globalState.productOrder.forEach(productId => {
                const product = globalState.products[productId];
                const calculated = calculateProductData(product);
                const isActive = globalState.selectedProduct === productId;
                
                const card = document.createElement('div');
                card.className = `product-card ${isActive ? 'active' : ''}`;
                card.onclick = () => selectProduct(productId);
                
                const statusClass = calculated.actualProfitPerOrder >= 0 ? 'status-profit' : 'status-loss';
                const statusText = calculated.actualProfitPerOrder >= 0 ? 'ç›ˆåˆ©' : 'äºæŸ';
                
                card.innerHTML = `
                    <div class="product-card-header">
                        <span class="product-name">${product.name}</span>
                        <span class="product-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="product-metrics">
                        <div>ROI: ${calculated.roi.toFixed(2)}</div>
                        <div>åˆ©æ¶¦ç‡: ${(calculated.actualProfitRate * 100).toFixed(1)}%</div>
                        <div>æ¯å•åˆ©æ¶¦: Â¥${calculated.actualProfitPerOrder.toFixed(2)}</div>
                        <div>é¢„ç®—: Â¥${(product.allocatedBudget || 0).toFixed(0)}</div>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        // æ¸²æŸ“æ•°æ®è¡¨æ ¼
        function renderDataTable() {
            const fixedColumnBody = document.getElementById('fixedColumnBody');
            const scrollableTableBody = document.getElementById('scrollableTableBody');
            const dynamicTableHeader = document.getElementById('dynamicTableHeader');
            
            fixedColumnBody.innerHTML = '';
            scrollableTableBody.innerHTML = '';
            
            // å®šä¹‰æ‰€æœ‰å¯ç”¨çš„åˆ—é…ç½®
            const allColumnConfigs = [
                { key: 'allocatedBudget', name: 'æ¨å¹¿é¢„ç®—', sortable: false, type: 'display' },
                { key: 'totalActualProfit', name: 'æ¨å¹¿å®é™…åˆ©æ¶¦', sortable: true, type: 'display' },
                { key: 'actualProfitPerOrder', name: 'æ¯å•å®é™…åˆ©æ¶¦', sortable: true, type: 'display' },
                { key: 'costPerOrder', name: 'æˆäº¤æ¯å•æˆæœ¬', sortable: true, type: 'display' },
                { key: 'salesUnits', name: 'æ¨å¹¿é”€å”®å•æ•°', sortable: true, type: 'display' },
                { key: 'salesRevenue', name: 'æ¨å¹¿é”€å”®é¢', sortable: true, type: 'display' },
                { key: 'platformFee', name: 'å•†åŸæ‰£ç‚¹', sortable: false, type: 'input' },
                { key: 'shippingRate', name: 'è¿è´¹å æ¯”', sortable: false, type: 'input' },
                { key: 'shippingCostPerOrder', name: 'æ¯å•è¿è´¹', sortable: false, type: 'input' },
                { key: 'laborCost', name: 'äººå‘˜å¼€é”€', sortable: false, type: 'input' },
                { key: 'price', name: 'äº§å“å”®ä»·', sortable: false, type: 'input' },
                { key: 'cost', name: 'äº§å“æˆæœ¬', sortable: false, type: 'input' },
                { key: 'clickPrice', name: 'ç‚¹å‡»å•ä»·', sortable: false, type: 'input' },
                { key: 'conversionRate', name: 'è½¬åŒ–ç‡', sortable: false, type: 'input' },
                { key: 'roi', name: 'æŠ•äº§æ¯”', sortable: false, type: 'display' },
                { key: 'actualPrice', name: 'å®é™…å”®ä»·', sortable: true, type: 'display' },
                { key: 'actualProfitRate', name: 'å®é™…åˆ©æ¶¦ç‡', sortable: false, type: 'display' },
                { key: 'grossProfitRate', name: 'å”®ä»·åˆ©æ¶¦ç‡', sortable: false, type: 'display' },
                { key: 'fixedCostRate', name: 'ä¿æœ¬åˆ©æ¶¦ç‡', sortable: false, type: 'display' },
                { key: 'breakevenPriceIncrease', name: 'æ¶¨ä»·ä¿æœ¬', sortable: false, type: 'display' },
                { key: 'breakevenCostReduction', name: 'é™æœ¬ä¿æœ¬', sortable: false, type: 'display' }
            ];
            
            // æ ¹æ®é…ç½®è¿‡æ»¤å¯è§åˆ—
            const visibleColumns = allColumnConfigs.filter(col => globalState.columnConfig[col.key]);
            
            // ç”ŸæˆåŠ¨æ€è¡¨å¤´
            let headerHTML = '';
            visibleColumns.forEach(col => {
                if (col.sortable) {
                    headerHTML += `
                        <div class="table-cell sortable" onclick="sortTable('${col.key}')">
                            ${col.name} <span class="sort-icon" id="sort-${col.key}">â‡…</span>
                        </div>
                    `;
                } else {
                    headerHTML += `<div class="table-cell">${col.name}</div>`;
                }
            });
            
            // å§‹ç»ˆæ·»åŠ æ“ä½œåˆ—
            headerHTML += '<div class="table-cell">æ“ä½œ</div>';
            
            // è®¡ç®—grid-template-columns
            const columnWidths = visibleColumns.map(() => '120px').join(' ') + ' 80px'; // æœ€å80pxæ˜¯æ“ä½œåˆ—
            dynamicTableHeader.style.gridTemplateColumns = columnWidths;
            dynamicTableHeader.innerHTML = headerHTML;

            globalState.productOrder.forEach(productId => {
                const product = globalState.products[productId];
                const calculated = calculateProductData(product);
                const isSelected = globalState.selectedProducts.has(productId);
                const isActive = globalState.selectedProduct === productId;
                
                // å›ºå®šåˆ—ï¼ˆå¤é€‰æ¡† + äº§å“åç§° + åˆ é™¤æŒ‰é’®ï¼‰
                const fixedRow = document.createElement('div');
                let fixedRowClass = 'table-cell';
                if (isSelected) fixedRowClass += ' fixed-row-selected';
                if (isActive) fixedRowClass += ' fixed-row-active';
                fixedRow.className = fixedRowClass;
                fixedRow.setAttribute('data-product-id', productId);
                fixedRow.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 4px; width: 100%; height: 100%;">
                        <input type="checkbox" class="product-checkbox" data-product-id="${productId}" 
                               onchange="toggleProductSelection('${productId}')" style="margin: 0;">
                        <input type="text" class="cell-input" value="${product.name}" 
                               onchange="updateProduct('${productId}', 'name', this.value)" 
                               onclick="selectProduct('${productId}')"
                               style="flex: 1; min-width: 50px; font-size: 11px; padding: 2px 4px;">
                        <button class="btn btn-secondary btn-icon" onclick="deleteProduct('${productId}')" 
                                title="åˆ é™¤" style="padding: 2px; font-size: 8px; width: 18px; height: 18px; min-width: 18px;">ğŸ—‘ï¸</button>
                    </div>
                `;
                fixedColumnBody.appendChild(fixedRow);
                
                // å¯æ»šåŠ¨åˆ—ï¼ˆæ ¹æ®é…ç½®åŠ¨æ€ç”Ÿæˆï¼‰
                const scrollableRow = document.createElement('div');
                let scrollableRowClass = 'table-row';
                if (isSelected) scrollableRowClass += ' table-row-selected';
                if (isActive) scrollableRowClass += ' table-row-active';
                scrollableRow.className = scrollableRowClass;
                scrollableRow.setAttribute('data-product-id', productId);
                scrollableRow.style.gridTemplateColumns = columnWidths;
                // æ·»åŠ ç‚¹å‡»é€‰æ‹©åŠŸèƒ½
                scrollableRow.onclick = () => selectProduct(productId);
                
                let cellsHTML = '';
                visibleColumns.forEach(col => {
                    cellsHTML += generateCellHTML(col, product, calculated, productId);
                });
                
                // å§‹ç»ˆæ·»åŠ æ“ä½œåˆ—
                cellsHTML += `
                    <div class="table-cell">
                        <div class="cell-label">æ“ä½œ</div>
                        <div class="cell-value neutral" style="font-size: 10px;">å·¦ä¾§åˆ é™¤</div>
                    </div>
                `;
                
                scrollableRow.innerHTML = cellsHTML;
                scrollableTableBody.appendChild(scrollableRow);
            });
            
            // è¡¨æ ¼æ¸²æŸ“å®Œæˆåï¼Œé‡æ–°æ£€æŸ¥æ»šåŠ¨æç¤ºå’Œæ›´æ–°æ’åºå›¾æ ‡
            setTimeout(() => {
                const container = document.querySelector('.table-scroll-container');
                const hint = document.getElementById('scrollHint');
                if (container && hint) {
                    const needsHorizontalScroll = container.scrollWidth > container.clientWidth;
                    if (needsHorizontalScroll && globalState.productOrder.length > 0) {
                        hint.classList.remove('hidden');
                        setTimeout(() => hint.classList.add('hidden'), 3000);
                    }
                }
                
                // æ›´æ–°æ’åºå›¾æ ‡
                updateSortIcons();
                
                // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                updateCheckboxStates();
            }, 100);
        }
        
        // ç”Ÿæˆå•å…ƒæ ¼HTMLçš„è¾…åŠ©å‡½æ•°
        function generateCellHTML(columnConfig, product, calculated, productId) {
            const { key, type } = columnConfig;
            
            if (type === 'input') {
                // è¾“å…¥ç±»å‹çš„å•å…ƒæ ¼
                let inputValue, inputType = 'number', step = '0.01';
                let label = columnConfig.name;
                
                switch (key) {
                    case 'platformFee':
                    case 'shippingRate':
                    case 'laborCost':
                        inputValue = product[key];
                        label += '%';
                        step = '0.1';
                        break;
                    case 'conversionRate':
                        inputValue = product[key];
                        label += '%';
                        step = '0.001';
                        break;
                    default:
                        inputValue = product[key];
                }
                
                return `
                    <div class="table-cell">
                        <div class="cell-label">${label}</div>
                        <input type="${inputType}" class="cell-input tooltip" step="${step}" value="${inputValue}" 
                               onchange="updateProduct('${productId}', '${key}', this.value)" 
                               data-tooltip="${getTooltipText(key, product, calculated)}">
                    </div>
                `;
            } else {
                // æ˜¾ç¤ºç±»å‹çš„å•å…ƒæ ¼
                let displayValue, valueClass = 'neutral';
                
                switch (key) {
                    case 'allocatedBudget':
                        displayValue = `Â¥${(product.allocatedBudget || 0).toFixed(2)}`;
                        break;
                    case 'totalActualProfit':
                        displayValue = `Â¥${calculated.totalActualProfit.toFixed(2)}`;
                        valueClass = calculated.totalActualProfit >= 0 ? 'positive' : 'negative';
                        break;
                    case 'actualProfitPerOrder':
                        displayValue = `Â¥${calculated.actualProfitPerOrder.toFixed(2)}`;
                        valueClass = calculated.actualProfitPerOrder >= 0 ? 'positive' : 'negative';
                        break;
                    case 'costPerOrder':
                        displayValue = `Â¥${calculated.costPerOrder.toFixed(2)}`;
                        break;
                    case 'salesUnits':
                        displayValue = calculated.salesUnits.toFixed(0);
                        break;
                    case 'salesRevenue':
                        displayValue = `Â¥${calculated.salesRevenue.toFixed(2)}`;
                        break;
                    case 'roi':
                        displayValue = calculated.roi.toFixed(2);
                        valueClass = calculated.roi >= 1 ? 'positive' : 'negative';
                        break;
                    case 'actualPrice':
                        displayValue = `Â¥${calculated.actualPrice.toFixed(2)}`;
                        valueClass = calculated.actualPrice >= 0 ? 'positive' : 'negative';
                        break;
                    case 'actualProfitRate':
                        displayValue = `${(calculated.actualProfitRate * 100).toFixed(1)}%`;
                        valueClass = calculated.actualProfitRate >= 0 ? 'positive' : 'negative';
                        break;
                    case 'grossProfitRate':
                        displayValue = `${(calculated.actualGrossProfitRate * 100).toFixed(1)}%`;
                        valueClass = calculated.actualGrossProfitRate >= 0 ? 'positive' : 'negative';
                        break;
                    case 'fixedCostRate':
                        displayValue = `${(calculated.fixedCostRate * 100).toFixed(1)}%`;
                        break;
                    case 'breakevenPriceIncrease':
                        displayValue = `${calculated.breakevenPriceIncrease >= 0 ? '+' : ''}Â¥${calculated.breakevenPriceIncrease.toFixed(2)}`;
                        valueClass = calculated.breakevenPriceIncrease > 0 ? 'negative' : 'positive';
                        break;
                    case 'breakevenCostReduction':
                        displayValue = `${calculated.breakevenCostReduction >= 0 ? '-' : '+'}Â¥${Math.abs(calculated.breakevenCostReduction).toFixed(2)}`;
                        valueClass = calculated.breakevenCostReduction > 0 ? 'positive' : 'negative';
                        break;
                    default:
                        displayValue = '-';
                }
                
                return `
                    <div class="table-cell">
                        <div class="cell-label">${columnConfig.name}</div>
                        <div class="cell-value ${valueClass} tooltip" data-tooltip="${getTooltipText(key, product, calculated)}">${displayValue}</div>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“ç»Ÿè®¡æ•°æ®
        function renderStats() {
            const container = document.getElementById('statsGrid');
            
            // è®¡ç®—æ±‡æ€»æ•°æ®
            let totalProducts = globalState.productOrder.length;
            let totalBudget = globalState.promotionBudget;
            let totalProfit = 0;
            let totalRevenue = 0;
            let profitableProducts = 0;

            globalState.productOrder.forEach(productId => {
                const product = globalState.products[productId];
                const calculated = calculateProductData(product);
                
                totalProfit += calculated.totalActualProfit;
                totalRevenue += calculated.salesRevenue;
                
                if (calculated.actualProfitPerOrder > 0) {
                    profitableProducts++;
                }
            });

            // æ ¹æ®åˆ†é…æ–¹å¼è°ƒæ•´æ€»é¢„ç®—æ˜¾ç¤º
            let actualTotalBudget = totalBudget;
            let budgetLabel = 'æ¨å¹¿é¢„ç®—';
            
            if (globalState.budgetAllocation === 'each_full') {
                actualTotalBudget = totalBudget * totalProducts;
                budgetLabel = 'æ€»æŠ•å…¥é¢„ç®—';
            }

            const avgROI = actualTotalBudget > 0 ? totalProfit / actualTotalBudget : 0;
            const profitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;

            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalProducts}</div>
                    <div class="stat-label">äº§å“æ€»æ•°</div>
                    <div class="stat-change positive">${profitableProducts} ä¸ªç›ˆåˆ©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">Â¥${actualTotalBudget.toFixed(0)}</div>
                    <div class="stat-label">${budgetLabel}</div>
                    <div class="stat-change neutral">${globalState.budgetAllocation === 'each_full' ? 'æ¯åº—Â¥' + totalBudget.toFixed(0) : 'å…¨å±€è®¾ç½®'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value ${totalProfit >= 0 ? 'positive' : 'negative'}">Â¥${totalProfit.toFixed(0)}</div>
                    <div class="stat-label">é¢„æœŸæ€»åˆ©æ¶¦</div>
                    <div class="stat-change ${profitMargin >= 0 ? 'positive' : 'negative'}">${profitMargin.toFixed(1)}% åˆ©æ¶¦ç‡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value ${avgROI >= 1 ? 'positive' : 'negative'}">${avgROI.toFixed(2)}</div>
                    <div class="stat-label">å¹³å‡ROI</div>
                    <div class="stat-change ${avgROI >= 1 ? 'positive' : 'negative'}">${avgROI >= 1 ? 'ç›ˆåˆ©' : 'äºæŸ'}</div>
                </div>
            `;
        }

        // æ›´æ–°äº§å“è®¡æ•°
        function updateProductCount() {
            document.getElementById('productCount').textContent = globalState.productOrder.length;
        }

        // æœ¬åœ°å­˜å‚¨
        function saveToStorage() {
            try {
                // åˆ›å»ºä¸€ä¸ªå¯åºåˆ—åŒ–çš„çŠ¶æ€å‰¯æœ¬
                const stateToSave = {
                    ...globalState,
                    // ä¸ä¿å­˜æ‰¹é‡é€‰æ‹©çŠ¶æ€ï¼Œè¿™äº›æ˜¯ä¸´æ—¶çš„UIçŠ¶æ€
                    selectedProducts: undefined,
                    selectAll: undefined
                };
                
                localStorage.setItem('productAnalyzerPro', JSON.stringify(stateToSave));
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
            }
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('productAnalyzerPro');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // ä¿æŒæ‰¹é‡é€‰æ‹©çŠ¶æ€ä¸è¢«è¦†ç›–
                    const currentSelectedProducts = globalState.selectedProducts;
                    const currentSelectAll = globalState.selectAll;
                    
                    globalState = { ...globalState, ...data };
                    
                    // æ¢å¤æ‰¹é‡é€‰æ‹©çŠ¶æ€
                    globalState.selectedProducts = currentSelectedProducts;
                    globalState.selectAll = currentSelectAll;
                    
                    // ç¡®ä¿defaultParamså­˜åœ¨
                    if (!globalState.defaultParams) {
                        globalState.defaultParams = {
                            platformFee: 8.0,
                            shippingRate: 7.0,
                            laborCost: 5.0,
                            shippingCostPerOrder: 0,
                            subsidyRate: 0.85
                        };
                    } else if (!globalState.defaultParams.subsidyRate) {
                        // ä¸ºç°æœ‰æ•°æ®æ·»åŠ å›½è¡¥ä¼˜æƒ ç³»æ•°
                        globalState.defaultParams.subsidyRate = 0.85;
                    }
                    
                    // ç¡®ä¿columnConfigå­˜åœ¨ä¸”åŒ…å«æ‰€æœ‰å­—æ®µ
                    if (!globalState.columnConfig) {
                        globalState.columnConfig = {
                            allocatedBudget: true,
                            totalActualProfit: true,
                            actualProfitPerOrder: true,
                            costPerOrder: true,
                            salesUnits: true,
                            salesRevenue: true,
                            platformFee: true,
                            shippingRate: true,
                            shippingCostPerOrder: true,
                            laborCost: true,
                            price: true,
                            cost: true,
                            clickPrice: true,
                            conversionRate: true,
                            roi: true,
                            actualPrice: true,
                            actualProfitRate: true,
                            grossProfitRate: true,
                            fixedCostRate: true,
                            breakevenPriceIncrease: true,
                            breakevenCostReduction: true
                        };
                    } else {
                        // ç¡®ä¿ç°æœ‰é…ç½®åŒ…å«æ‰€æœ‰æ–°å­—æ®µ
                        const defaultColumnConfig = {
                            allocatedBudget: true,
                            totalActualProfit: true,
                            actualProfitPerOrder: true,
                            costPerOrder: true,
                            salesUnits: true,
                            salesRevenue: true,
                            platformFee: true,
                            shippingRate: true,
                            shippingCostPerOrder: true,
                            laborCost: true,
                            price: true,
                            cost: true,
                            clickPrice: true,
                            conversionRate: true,
                            roi: true,
                            actualPrice: true,
                            actualProfitRate: true,
                            grossProfitRate: true,
                            fixedCostRate: true,
                            breakevenPriceIncrease: true,
                            breakevenCostReduction: true
                        };
                        
                        // æ·»åŠ ç¼ºå¤±çš„å­—æ®µ
                        Object.keys(defaultColumnConfig).forEach(key => {
                            if (!(key in globalState.columnConfig)) {
                                globalState.columnConfig[key] = defaultColumnConfig[key];
                            }
                        });
                    }
                    
                    // æ›´æ–°UI
                    document.getElementById('globalPromotionBudget').value = globalState.promotionBudget;
                    document.getElementById('budgetAllocation').value = globalState.budgetAllocation;
                    document.getElementById('defaultPlatformFee').value = globalState.defaultParams.platformFee;
                    document.getElementById('defaultShippingRate').value = globalState.defaultParams.shippingRate;
                    document.getElementById('defaultLaborCost').value = globalState.defaultParams.laborCost;
                    document.getElementById('defaultSubsidyRate').value = globalState.defaultParams.subsidyRate;
                } catch (e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                    // å¦‚æœåŠ è½½å¤±è´¥ï¼Œé‡ç½®ä¸ºé»˜è®¤çŠ¶æ€
                    resetToDefaultState();
                }
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œè®¾ç½®é»˜è®¤å€¼
                document.getElementById('globalPromotionBudget').value = globalState.promotionBudget;
                document.getElementById('budgetAllocation').value = globalState.budgetAllocation;
                document.getElementById('defaultPlatformFee').value = globalState.defaultParams.platformFee;
                document.getElementById('defaultShippingRate').value = globalState.defaultParams.shippingRate;
                document.getElementById('defaultLaborCost').value = globalState.defaultParams.laborCost;
                document.getElementById('defaultSubsidyRate').value = globalState.defaultParams.subsidyRate;
            }
        }
        
        // é‡ç½®ä¸ºé»˜è®¤çŠ¶æ€
        function resetToDefaultState() {
            globalState = {
                promotionBudget: 10000,
                budgetAllocation: 'each_full',
                defaultParams: {
                    platformFee: 8.0,
                    shippingRate: 7.0,
                    laborCost: 5.0,
                    shippingCostPerOrder: 0,
                    subsidyRate: 0.85
                },
                products: {},
                productOrder: [],
                selectedProduct: null,
                productCount: 0,
                sortField: null,
                sortDirection: 'desc',
                selectedProducts: new Set(),
                selectAll: false,
                columnConfig: {
                    allocatedBudget: true,
                    totalActualProfit: true,
                    actualProfitPerOrder: true,
                    costPerOrder: true,
                    salesUnits: true,
                    salesRevenue: true,
                    platformFee: true,
                    shippingRate: true,
                    shippingCostPerOrder: true,
                    laborCost: true,
                    price: true,
                    cost: true,
                    clickPrice: true,
                    conversionRate: true,
                    roi: true,
                    actualPrice: true,
                    actualProfitRate: true,
                    grossProfitRate: true,
                    fixedCostRate: true,
                    breakevenPriceIncrease: true,
                    breakevenCostReduction: true
                }
            };
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataToExport = {
                ...globalState,
                exportTime: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `äº§å“åˆ†ææ•°æ®_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm('å¯¼å…¥æ•°æ®å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                            globalState = { ...globalState, ...data };
                            initApp();
                            alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                        }
                    } catch (error) {
                        alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œå¯¼å…¥å¤±è´¥ï¼');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // å…¶ä»–åŠŸèƒ½å‡½æ•°
        function toggleTheme() {
            // TODO: å®ç°ä¸»é¢˜åˆ‡æ¢
            alert('ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½å¼€å‘ä¸­...');
        }

        function refreshData() {
            renderProductList();
            renderDataTable();
            renderStats();
        }

        function generateReport() {
            // TODO: å®ç°æŠ¥å‘Šç”Ÿæˆ
            alert('æŠ¥å‘Šç”ŸæˆåŠŸèƒ½å¼€å‘ä¸­...');
        }

        function quickAdd() {
            addProduct();
        }

        // å¿«é€Ÿå…¨é€‰/å–æ¶ˆå…¨é€‰åŠŸèƒ½
        function quickSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            if (!selectAllCheckbox) return;
            
            // å¦‚æœå½“å‰æ²¡æœ‰äº§å“ï¼Œç›´æ¥è¿”å›
            if (globalState.productOrder.length === 0) {
                alert('æš‚æ— äº§å“å¯é€‰æ‹©');
                return;
            }
            
            // åˆ‡æ¢å…¨é€‰çŠ¶æ€
            const currentSelectedCount = globalState.selectedProducts.size;
            const totalProducts = globalState.productOrder.length;
            
            if (currentSelectedCount === totalProducts) {
                // å½“å‰å…¨é€‰çŠ¶æ€ï¼Œæ‰§è¡Œå–æ¶ˆå…¨é€‰
                globalState.selectedProducts.clear();
                globalState.selectAll = false;
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                
                // æ›´æ–°æ‰€æœ‰è¡Œçš„é«˜äº®çŠ¶æ€
                globalState.productOrder.forEach(productId => {
                    updateRowHighlight(productId);
                });
            } else {
                // å½“å‰éå…¨é€‰çŠ¶æ€ï¼Œæ‰§è¡Œå…¨é€‰
                globalState.selectedProducts.clear();
                globalState.productOrder.forEach(productId => {
                    globalState.selectedProducts.add(productId);
                });
                globalState.selectAll = true;
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
                
                // æ›´æ–°æ‰€æœ‰è¡Œçš„é«˜äº®çŠ¶æ€
                globalState.productOrder.forEach(productId => {
                    updateRowHighlight(productId);
                });
            }
            
            // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€å’Œæ‰¹é‡åˆ é™¤æŒ‰é’®
            updateCheckboxStates();
            updateBatchActionButtons();
        }

        // è¡¨æ ¼å¯¼å…¥åŠŸèƒ½
        function importTableData() {
            console.log('å¼€å§‹è¡¨æ ¼å¯¼å…¥...');
            try {
                importState = {
                    currentStep: 1,
                    fileData: null,
                    fieldMapping: {},
                    previewData: []
                };
                
                document.getElementById('importModal').style.display = 'flex';
                showStep(1);
                
                // æ¨¡æ€æ¡†æ‰“å¼€ååˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
                setTimeout(() => {
                    initDragDrop();
                }, 100);
                
                console.log('å¯¼å…¥æ¨¡æ€æ¡†å·²æ‰“å¼€');
            } catch (error) {
                console.error('æ‰“å¼€å¯¼å…¥æ¨¡æ€æ¡†å¤±è´¥:', error);
                alert('å¯¼å…¥åŠŸèƒ½å¯åŠ¨å¤±è´¥: ' + error.message);
            }
        }

        function closeImportModal() {
            document.getElementById('importModal').style.display = 'none';
        }

        function initDragDrop() {
            // åœ¨å¯¼å…¥æ¨¡æ€æ¡†æ‰“å¼€æ—¶æ‰åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            const dropZone = document.getElementById('fileDropZone');
            
            if (!dropZone) {
                console.warn('fileDropZone element not found');
                return;
            }
            
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });
            
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });
            
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleTableFile({ target: { files: files } });
                }
            });
        }

        function handleTableFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            console.log('å¼€å§‹å¤„ç†æ–‡ä»¶:', file.name, 'å¤§å°:', file.size, 'ç±»å‹:', file.type);

            const fileName = file.name.toLowerCase();
            const fileExtension = fileName.split('.').pop();

            // æ”¯æŒçš„æ–‡ä»¶æ ¼å¼
            const supportedFormats = ['xlsx', 'xls', 'csv', 'tsv', 'ods'];
            
            if (!supportedFormats.includes(fileExtension)) {
                alert(`ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼\næ”¯æŒçš„æ ¼å¼ï¼š${supportedFormats.map(f => '.' + f).join(', ')}`);
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œå¼€å§‹è§£æ...');
                    let data;
                    
                    if (fileExtension === 'csv') {
                        // CSV æ ¼å¼è§£æ - å¤„ç†ç¼–ç 
                        const textContent = detectAndDecodeText(e.target.result);
                        data = parseCSV(textContent);
                    } else if (fileExtension === 'tsv') {
                        // TSV æ ¼å¼è§£æ - å¤„ç†ç¼–ç   
                        const textContent = detectAndDecodeText(e.target.result);
                        data = parseTSV(textContent);
                    } else if (['xlsx', 'xls', 'ods'].includes(fileExtension)) {
                        // Excel å’Œ ODS æ ¼å¼è§£æ
                        data = parseExcel(e.target.result);
                    } else {
                        throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼');
                    }
                    
                    console.log('æ–‡ä»¶è§£ææˆåŠŸ:', data);
                    
                    if (!data || !data.headers || !data.rows || data.rows.length === 0) {
                        throw new Error('æ–‡ä»¶ä¸­æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆæ•°æ®');
                    }
                    
                    importState.fileData = data;
                    processFieldMapping(data);
                    nextStep();
                } catch (error) {
                    console.error('æ–‡ä»¶è§£æå¤±è´¥:', error);
                    alert(`æ–‡ä»¶è§£æå¤±è´¥ï¼\né”™è¯¯ä¿¡æ¯ï¼š${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®\n2. æ–‡ä»¶æ˜¯å¦åŒ…å«è¡¨å¤´\n3. æ–‡ä»¶æ˜¯å¦åŒ…å«æ•°æ®è¡Œ`);
                }
            };
            
            // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©è¯»å–æ–¹å¼
            if (['csv', 'tsv'].includes(fileExtension)) {
                // å°è¯•å¤šç§ç¼–ç è¯»å–æ–‡æœ¬æ–‡ä»¶
                reader.readAsArrayBuffer(file);  // å…ˆè¯»å–ä¸ºArrayBufferå¤„ç†ç¼–ç 
            } else {
                reader.readAsArrayBuffer(file);
            }
        }

        // æ£€æµ‹å’Œå¤„ç†æ–‡ä»¶ç¼–ç 
        function detectAndDecodeText(arrayBuffer) {
            // å°è¯•ä¸åŒç¼–ç 
            const encodings = ['utf-8', 'gbk', 'gb2312'];
            
            for (const encoding of encodings) {
                try {
                    const decoder = new TextDecoder(encoding);
                    const text = decoder.decode(arrayBuffer);
                    
                    // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¹±ç å­—ç¬¦
                    if (!text.includes('ï¿½') && text.length > 0) {
                        console.log(`æˆåŠŸä½¿ç”¨ ${encoding} ç¼–ç è§£ææ–‡ä»¶`);
                        return text;
                    }
                } catch (error) {
                    console.log(`å°è¯• ${encoding} ç¼–ç å¤±è´¥:`, error);
                }
            }
            
            // å¦‚æœéƒ½å¤±è´¥ï¼Œä½¿ç”¨UTF-8ä½œä¸ºé»˜è®¤
            console.log('ä½¿ç”¨UTF-8ä½œä¸ºé»˜è®¤ç¼–ç ');
            const decoder = new TextDecoder('utf-8');
            return decoder.decode(arrayBuffer);
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('CSVæ–‡ä»¶è‡³å°‘éœ€è¦åŒ…å«è¡¨å¤´å’Œä¸€è¡Œæ•°æ®');
            }
            
            // æ”¹è¿›çš„CSVè§£æï¼Œæ”¯æŒå¼•å·å†…çš„é€—å·
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current.trim());
                return result.map(cell => cell.replace(/^"|"$/g, ''));
            }
            
            const headers = parseCSVLine(lines[0]);
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    rows.push(row);
                }
            }
            
            return { headers, rows };
        }

        function parseTSV(tsvText) {
            const lines = tsvText.split('\n').filter(line => line.trim());
            if (lines.length < 2) {
                throw new Error('TSVæ–‡ä»¶è‡³å°‘éœ€è¦åŒ…å«è¡¨å¤´å’Œä¸€è¡Œæ•°æ®');
            }
            
            const headers = lines[0].split('\t').map(h => h.trim());
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split('\t').map(v => v.trim());
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index];
                    });
                    rows.push(row);
                }
            }
            
            return { headers, rows };
        }

        function parseExcel(arrayBuffer) {
            try {
                // ä½¿ç”¨ SheetJS è§£æ Excel æ–‡ä»¶
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // è½¬æ¢ä¸ºJSONæ ¼å¼
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    throw new Error('Excelæ–‡ä»¶è‡³å°‘éœ€è¦åŒ…å«è¡¨å¤´å’Œä¸€è¡Œæ•°æ®');
                }
                
                const headers = jsonData[0].map(h => String(h || '').trim());
                const rows = [];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const rowData = jsonData[i];
                    if (rowData && rowData.length > 0) {
                        const row = {};
                        let hasData = false;
                        
                        headers.forEach((header, index) => {
                            const value = String(rowData[index] || '').trim();
                            row[header] = value;
                            if (value) hasData = true;
                        });
                        
                        // åªæ·»åŠ æœ‰æ•°æ®çš„è¡Œ
                        if (hasData) {
                            rows.push(row);
                        }
                    }
                }
                
                return { headers, rows };
            } catch (error) {
                console.error('Excelè§£æé”™è¯¯:', error);
                throw new Error('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸåæˆ–æ ¼å¼æ˜¯å¦æ­£ç¡®');
            }
        }

        function processFieldMapping(data) {
            const mapping = {};
            const mappingContainer = document.getElementById('fieldMapping');
            mappingContainer.innerHTML = '';
            
            console.log('å¼€å§‹å¤„ç†å­—æ®µæ˜ å°„:', data.headers);
            
            data.headers.forEach((header, index) => {
                const originalHeader = header;
                const normalizedHeader = header.toLowerCase().trim().replace(/[_\s-]/g, '');
                let targetField = null;
                
                // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ç¬¬ä¸‰åˆ—ä¸”å†…å®¹çœ‹èµ·æ¥åƒä¹±ç ï¼Œå¾ˆå¯èƒ½æ˜¯äº§å“æˆæœ¬
                if (index === 2 && (header.includes('ï¿½ï¿½') || header.includes('ï¿½É±ï¿½') || originalHeader.length < 10)) {
                    targetField = 'cost';
                    mapping[originalHeader] = 'cost';
                }
                // ç²¾ç¡®åŒ¹é…
                else if (FIELD_MAPPINGS[header]) {
                    targetField = FIELD_MAPPINGS[header];
                } else if (FIELD_MAPPINGS[header.toLowerCase()]) {
                    targetField = FIELD_MAPPINGS[header.toLowerCase()];
                } else {
                    // æ¨¡ç³ŠåŒ¹é…
                    for (const [pattern, field] of Object.entries(FIELD_MAPPINGS)) {
                        const normalizedPattern = pattern.toLowerCase().replace(/[_\s-]/g, '');
                        if (normalizedHeader.includes(normalizedPattern) || 
                            header.includes(pattern) || 
                            pattern.includes(header)) {
                            targetField = field;
                            mapping[originalHeader] = field;
                            break;
                        }
                    }
                }
                
                if (targetField) {
                    mapping[originalHeader] = targetField;
                    const mapItem = document.createElement('div');
                    mapItem.className = 'field-map-item';
                    mapItem.innerHTML = `
                        <div class="field-source">${originalHeader}</div>
                        <div class="field-arrow">â†’</div>
                        <div class="field-target">${getFieldDisplayName(targetField)}</div>
                    `;
                    mappingContainer.appendChild(mapItem);
                }
            });
            
            importState.fieldMapping = mapping;
            
            console.log('å­—æ®µæ˜ å°„ç»“æœ:', mapping);
            
            if (Object.keys(mapping).length === 0) {
                mappingContainer.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: var(--warning-color);">
                        <h4>âš ï¸ æœªæ‰¾åˆ°åŒ¹é…çš„å­—æ®µ</h4>
                        <p>è¯·æ£€æŸ¥æ–‡ä»¶ä¸­çš„åˆ—åæ˜¯å¦åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š</p>
                        <ul style="text-align: left; margin: 16px 0; color: var(--gray-600);">
                            <li><strong>äº§å“åç§°ï¼š</strong>ä¸»ä½“åç§°ã€äº§å“åç§°ã€å•†å“åç§°ã€åç§°ç­‰</li>
                            <li><strong>æŠ•äº§æ¯”ï¼š</strong>æŠ•äº§æ¯”ã€æŠ•å…¥äº§å‡ºæ¯”ã€ROIã€ROASç­‰</li>
                            <li><strong>ç‚¹å‡»å•ä»·ï¼š</strong>å¹³å‡ç‚¹å‡»èŠ±è´¹ã€ç‚¹å‡»å•ä»·ã€CPCç­‰</li>
                            <li><strong>è½¬åŒ–ç‡ï¼š</strong>ç‚¹å‡»è½¬åŒ–ç‡ã€è½¬åŒ–ç‡ã€CVRç­‰</li>
                            <li><strong>äº§å“å”®ä»·ï¼š</strong>äº§å“å”®ä»·ã€å•†å“å”®ä»·ã€å”®ä»·ã€å•ä»·ã€ä»·æ ¼ç­‰</li>
                            <li><strong>äº§å“æˆæœ¬ï¼š</strong>äº§å“æˆæœ¬ã€å•†å“æˆæœ¬ã€æˆæœ¬ã€è¿›è´§ä»·ã€é‡‡è´­ä»·ç­‰</li>
                        </ul>
                        <p style="margin-top: 8px; font-size: 12px; color: var(--primary-color);">
                            <strong>æ³¨æ„ï¼š</strong>å¦‚æœè¡¨æ ¼ä¸­æœ‰æŠ•äº§æ¯”ã€ç‚¹å‡»å•ä»·ã€è½¬åŒ–ç‡ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—äº§å“å”®ä»·
                        </p>
                        <p>æ£€æµ‹åˆ°çš„åˆ—åï¼š${data.headers.join(', ')}</p>
                    </div>
                `;
            } else {
                // æ·»åŠ æˆåŠŸæç¤º
                const successDiv = document.createElement('div');
                successDiv.innerHTML = `
                    <div style="padding: 16px; background: var(--success-light); border-radius: 8px; margin-bottom: 16px; color: var(--success-color);">
                        <strong>âœ… æˆåŠŸè¯†åˆ« ${Object.keys(mapping).length} ä¸ªå­—æ®µ</strong>
                    </div>
                `;
                mappingContainer.insertBefore(successDiv, mappingContainer.firstChild);
            }
        }

        function getFieldDisplayName(field) {
            const displayNames = {
                'name': 'äº§å“åç§°',
                'price': 'äº§å“å”®ä»·',
                'cost': 'äº§å“æˆæœ¬',
                'clickPrice': 'ç‚¹å‡»å•ä»·', 
                'conversionRate': 'è½¬åŒ–ç‡',
                'roi': 'æŠ•äº§æ¯”'
            };
            return displayNames[field] || field;
        }

        function showStep(step) {
            // éšè—æ‰€æœ‰æ­¥éª¤
            for (let i = 1; i <= 3; i++) {
                document.getElementById(`step${i}`).style.display = 'none';
            }
            
            // æ˜¾ç¤ºå½“å‰æ­¥éª¤
            document.getElementById(`step${step}`).style.display = 'block';
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const importBtn = document.getElementById('importBtn');
            
            prevBtn.style.display = step > 1 ? 'inline-flex' : 'none';
            nextBtn.style.display = step < 3 ? 'inline-flex' : 'none';
            importBtn.style.display = step === 3 ? 'inline-flex' : 'none';
            
            importState.currentStep = step;
        }

        function nextStep() {
            if (importState.currentStep === 1) {
                if (!importState.fileData) {
                    alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼');
                    return;
                }
                showStep(2);
            } else if (importState.currentStep === 2) {
                generatePreview();
                showStep(3);
            }
        }

        function prevStep() {
            if (importState.currentStep > 1) {
                showStep(importState.currentStep - 1);
            }
        }

        function generatePreview() {
            const previewContainer = document.getElementById('dataPreview');
            const { rows } = importState.fileData;
            const { fieldMapping } = importState;
            
            // å¤„ç†æ•°æ®
            const processedData = rows.slice(0, 10).map(row => {
                const processed = {};
                Object.entries(fieldMapping).forEach(([sourceField, targetField]) => {
                    let value = row[sourceField] || '';
                    
                    // æ•°æ®æ¸…ç†å’Œè½¬æ¢
                    if (targetField === 'clickPrice' || targetField === 'conversionRate' || targetField === 'price' || targetField === 'roi' || targetField === 'cost') {
                        // ç§»é™¤è´§å¸ç¬¦å·å’Œç™¾åˆ†å·
                        value = value.replace(/[Â¥$%,]/g, '');
                        value = parseFloat(value) || 0;
                        
                        // è½¬åŒ–ç‡å¦‚æœå°äº1ï¼Œå‡è®¾æ˜¯ç™¾åˆ†æ¯”çš„å°æ•°å½¢å¼ï¼ˆå¦‚0.00746ï¼‰ï¼Œéœ€è¦è½¬æ¢ä¸ºç™¾åˆ†æ¯”æ˜¾ç¤ºå½¢å¼
                        if (targetField === 'conversionRate' && value < 1 && value > 0) {
                            value = value * 100; // è½¬æ¢ä¸ºç™¾åˆ†æ¯”å½¢å¼ï¼ˆå¦‚0.746ï¼‰
                        }
                    }
                    
                    processed[targetField] = value;
                });
                
                // å¦‚æœæœ‰æŠ•äº§æ¯”ã€ç‚¹å‡»å•ä»·ã€è½¬åŒ–ç‡ï¼Œä½†æ²¡æœ‰ç›´æ¥çš„å”®ä»·ï¼Œåˆ™è®¡ç®—å”®ä»·
                if (processed.roi && processed.clickPrice && processed.conversionRate && !processed.price) {
                    // å…¬å¼ï¼šæŠ•äº§æ¯” Ã— ç‚¹å‡»å•ä»· Ã· ç‚¹å‡»è½¬åŒ–ç‡ = äº§å“å”®ä»·
                    const conversionRateDecimal = processed.conversionRate / 100; // è½¬æ¢ä¸ºå°æ•°
                    if (conversionRateDecimal > 0) {
                        processed.price = (processed.roi * processed.clickPrice) / conversionRateDecimal;
                    }
                }
                
                return processed;
            });
            
            importState.previewData = processedData;
            
            // ç”Ÿæˆé¢„è§ˆè¡¨æ ¼
            let tableHTML = `
                <table class="preview-table">
                    <thead>
                        <tr>
                            <th>äº§å“åç§°</th>
                            <th>æŠ•äº§æ¯”</th>
                            <th>ç‚¹å‡»å•ä»·</th>
                            <th>è½¬åŒ–ç‡</th>
                            <th>äº§å“å”®ä»·</th>
                            <th>äº§å“æˆæœ¬</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            processedData.forEach(item => {
                // æ£€æŸ¥å”®ä»·æ˜¯å¦æ˜¯è®¡ç®—å¾—å‡ºçš„
                const isPriceCalculated = item.roi && item.clickPrice && item.conversionRate && item.price && !item.originalPrice;
                const priceDisplay = item.price ? 
                    (isPriceCalculated ? 'Â¥' + item.price.toFixed(2) + ' (è®¡ç®—)' : 'Â¥' + item.price.toFixed(2)) : 
                    '-';
                    
                tableHTML += `
                    <tr>
                        <td>${item.name || '-'}</td>
                        <td>${item.roi ? item.roi.toFixed(2) : '-'}</td>
                        <td>${item.clickPrice ? 'Â¥' + item.clickPrice.toFixed(2) : '-'}</td>
                        <td>${item.conversionRate ? item.conversionRate.toFixed(3) + '%' : '-'}</td>
                        <td>${priceDisplay}</td>
                        <td>${item.cost ? 'Â¥' + item.cost.toFixed(2) : '-'}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            
            if (rows.length > 10) {
                tableHTML += `<p style="margin-top: 16px; color: var(--gray-600); font-size: 12px;">é¢„è§ˆå‰10æ¡æ•°æ®ï¼Œå…±${rows.length}æ¡</p>`;
            }
            
            previewContainer.innerHTML = tableHTML;
        }

        function confirmImport() {
            const { rows } = importState.fileData;
            const { fieldMapping } = importState;
            
            let importedCount = 0;
            
            rows.forEach(row => {
                const productData = {};
                Object.entries(fieldMapping).forEach(([sourceField, targetField]) => {
                    let value = row[sourceField] || '';
                    
                    if (targetField === 'clickPrice' || targetField === 'conversionRate' || targetField === 'price' || targetField === 'roi' || targetField === 'cost') {
                        value = value.replace(/[Â¥$%,]/g, '');
                        value = parseFloat(value) || 0;
                        
                        // è½¬åŒ–ç‡å¦‚æœå°äº1ï¼Œå‡è®¾æ˜¯ç™¾åˆ†æ¯”çš„å°æ•°å½¢å¼ï¼Œéœ€è¦è½¬æ¢ä¸ºç™¾åˆ†æ¯”æ˜¾ç¤ºå½¢å¼
                        if (targetField === 'conversionRate' && value < 1 && value > 0) {
                            value = value * 100;
                        }
                    }
                    
                    productData[targetField] = value;
                });
                
                // å¦‚æœæœ‰æŠ•äº§æ¯”ã€ç‚¹å‡»å•ä»·ã€è½¬åŒ–ç‡ï¼Œä½†æ²¡æœ‰ç›´æ¥çš„å”®ä»·ï¼Œåˆ™è®¡ç®—å”®ä»·
                if (productData.roi && productData.clickPrice && productData.conversionRate && !productData.price) {
                    // å…¬å¼ï¼šæŠ•äº§æ¯” Ã— ç‚¹å‡»å•ä»· Ã· ç‚¹å‡»è½¬åŒ–ç‡ = äº§å“å”®ä»·
                    const conversionRateDecimal = productData.conversionRate / 100; // è½¬æ¢ä¸ºå°æ•°
                    if (conversionRateDecimal > 0) {
                        productData.price = (productData.roi * productData.clickPrice) / conversionRateDecimal;
                    }
                }
                
                // åªæœ‰åç§°ä¸ä¸ºç©ºæ‰åˆ›å»ºäº§å“
                if (productData.name && productData.name.trim()) {
                    globalState.productCount++;
                    const productId = `product_${globalState.productCount}`;
                    
                    globalState.products[productId] = {
                        id: productId,
                        name: productData.name.trim(),
                        price: productData.price || 0,
                        cost: productData.cost || 0,
                        clickPrice: productData.clickPrice || 0,
                        conversionRate: productData.conversionRate || 0,
                        weight: 1,
                        ...globalState.defaultParams
                    };
                    
                    globalState.productOrder.push(productId);
                    importedCount++;
                }
            });
            
            // é‡æ–°åˆ†é…é¢„ç®—
            distributeBudget();
            
            // æ›´æ–°ç•Œé¢
            renderProductList();
            renderDataTable();
            renderStats();
            updateProductCount();
            saveToStorage();
            
            closeImportModal();
            alert(`æˆåŠŸå¯¼å…¥ ${importedCount} ä¸ªäº§å“ï¼`);
        }

        // æŒ‡æ ‡é…ç½®åŠŸèƒ½
        function openColumnConfig() {
            renderColumnConfigList();
            document.getElementById('columnConfigModal').style.display = 'flex';
        }
        
        function closeColumnConfig() {
            document.getElementById('columnConfigModal').style.display = 'none';
        }
        
        function renderColumnConfigList() {
            const container = document.getElementById('columnConfigList');
            const columnDefinitions = [
                { key: 'allocatedBudget', name: 'æ¨å¹¿é¢„ç®—', category: 'åŸºç¡€' },
                { key: 'totalActualProfit', name: 'æ¨å¹¿å®é™…åˆ©æ¶¦', category: 'åˆ©æ¶¦' },
                { key: 'actualProfitPerOrder', name: 'æ¯å•å®é™…åˆ©æ¶¦', category: 'åˆ©æ¶¦' },
                { key: 'costPerOrder', name: 'æˆäº¤æ¯å•æˆæœ¬', category: 'æˆæœ¬' },
                { key: 'salesUnits', name: 'æ¨å¹¿é”€å”®å•æ•°', category: 'é”€å”®' },
                { key: 'salesRevenue', name: 'æ¨å¹¿é”€å”®é¢', category: 'é”€å”®' },
                { key: 'platformFee', name: 'å•†åŸæ‰£ç‚¹', category: 'è´¹ç”¨' },
                { key: 'shippingRate', name: 'è¿è´¹å æ¯”', category: 'è´¹ç”¨' },
                { key: 'shippingCostPerOrder', name: 'æ¯å•è¿è´¹', category: 'è´¹ç”¨' },
                { key: 'laborCost', name: 'äººå‘˜å¼€é”€', category: 'è´¹ç”¨' },
                { key: 'price', name: 'äº§å“å”®ä»·', category: 'åŸºç¡€' },
                { key: 'cost', name: 'äº§å“æˆæœ¬', category: 'æˆæœ¬' },
                { key: 'clickPrice', name: 'ç‚¹å‡»å•ä»·', category: 'æ¨å¹¿' },
                { key: 'conversionRate', name: 'è½¬åŒ–ç‡', category: 'æ¨å¹¿' },
                { key: 'roi', name: 'æŠ•äº§æ¯”', category: 'æ¨å¹¿' },
                { key: 'actualPrice', name: 'å®é™…å”®ä»·', category: 'åŸºç¡€' },
                { key: 'actualProfitRate', name: 'å®é™…åˆ©æ¶¦ç‡', category: 'åˆ©æ¶¦' },
                { key: 'grossProfitRate', name: 'å”®ä»·åˆ©æ¶¦ç‡', category: 'åˆ©æ¶¦' },
                { key: 'fixedCostRate', name: 'ä¿æœ¬åˆ©æ¶¦ç‡', category: 'åˆ†æ' },
                { key: 'breakevenPriceIncrease', name: 'æ¶¨ä»·ä¿æœ¬', category: 'åˆ†æ' },
                { key: 'breakevenCostReduction', name: 'é™æœ¬ä¿æœ¬', category: 'åˆ†æ' }
            ];
            
            // æŒ‰ç±»åˆ«åˆ†ç»„
            const categories = {};
            columnDefinitions.forEach(col => {
                if (!categories[col.category]) {
                    categories[col.category] = [];
                }
                categories[col.category].push(col);
            });
            
            let html = '';
            Object.entries(categories).forEach(([category, columns]) => {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h5 style="color: var(--primary-color); margin-bottom: 12px; font-size: 14px; border-bottom: 1px solid var(--gray-200); padding-bottom: 4px;">
                            ğŸ“Š ${category}æŒ‡æ ‡
                        </h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px;">
                `;
                
                columns.forEach(col => {
                    const isChecked = globalState.columnConfig[col.key] ? 'checked' : '';
                    html += `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: white; border-radius: 6px; border: 1px solid var(--gray-200); cursor: pointer; transition: all 0.2s ease;" 
                               onmouseover="this.style.borderColor='var(--primary-color)'" 
                               onmouseout="this.style.borderColor='var(--gray-200)'">
                            <input type="checkbox" ${isChecked} onchange="toggleColumnConfig('${col.key}')" 
                                   style="margin: 0;">
                            <span style="font-size: 13px; color: var(--gray-700);">${col.name}</span>
                        </label>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function toggleColumnConfig(columnKey) {
            globalState.columnConfig[columnKey] = !globalState.columnConfig[columnKey];
            saveToStorage();
        }
        
        function selectAllColumns() {
            Object.keys(globalState.columnConfig).forEach(key => {
                globalState.columnConfig[key] = true;
            });
            renderColumnConfigList();
            saveToStorage();
        }
        
        function selectNoneColumns() {
            Object.keys(globalState.columnConfig).forEach(key => {
                globalState.columnConfig[key] = false;
            });
            renderColumnConfigList();
            saveToStorage();
        }
        
        function selectCoreColumns() {
            // é‡ç½®æ‰€æœ‰ä¸ºfalse
            Object.keys(globalState.columnConfig).forEach(key => {
                globalState.columnConfig[key] = false;
            });
            
            // åªé€‰æ‹©æ ¸å¿ƒæŒ‡æ ‡
            const coreColumns = ['allocatedBudget', 'totalActualProfit', 'actualProfitPerOrder', 'salesUnits', 'actualPrice', 'actualProfitRate'];
            coreColumns.forEach(key => {
                if (globalState.columnConfig.hasOwnProperty(key)) {
                    globalState.columnConfig[key] = true;
                }
            });
            
            renderColumnConfigList();
            saveToStorage();
        }
        
        function selectProfitColumns() {
            // é‡ç½®æ‰€æœ‰ä¸ºfalse
            Object.keys(globalState.columnConfig).forEach(key => {
                globalState.columnConfig[key] = false;
            });
            
            // åªé€‰æ‹©åˆ©æ¶¦åˆ†æç›¸å…³æŒ‡æ ‡
            const profitColumns = ['totalActualProfit', 'actualProfitPerOrder', 'costPerOrder', 'actualPrice', 'cost', 'actualProfitRate', 'grossProfitRate', 'fixedCostRate', 'breakevenPriceIncrease', 'breakevenCostReduction'];
            profitColumns.forEach(key => {
                if (globalState.columnConfig.hasOwnProperty(key)) {
                    globalState.columnConfig[key] = true;
                }
            });
            
            renderColumnConfigList();
            saveToStorage();
        }
        
        function applyColumnConfig() {
            closeColumnConfig();
            renderDataTable(); // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥åº”ç”¨åˆ—é…ç½®
            alert('æŒ‡æ ‡é…ç½®å·²åº”ç”¨ï¼');
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
